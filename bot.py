#!/usr/bin/env python3
"""
Konspekt Helper Bot - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤—Å–µ—Ö –æ–±—ä–µ–º–æ–≤
"""

import os
import logging
import json
import requests
from datetime import datetime
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading
import random
import re

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø ====================
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
GOOGLE_CSE_ID = os.getenv("GOOGLE_CSE_ID", "13aac457275834df9")
RENDER_EXTERNAL_URL = os.getenv("RENDER_EXTERNAL_URL", "")
PORT = int(os.getenv("PORT", 10000))

# ==================== –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====================
logger.info("=" * 60)
logger.info("üöÄ –ó–ê–ü–£–°–ö KONSPEKT HELPER BOT (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)")
logger.info("=" * 60)

if not TELEGRAM_TOKEN:
    logger.error("‚ùå TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    exit(1)

if not GOOGLE_API_KEY:
    logger.warning("‚ö†Ô∏è GOOGLE_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ")

# ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
stats = {
    "total_users": 0,
    "total_messages": 0,
    "conspects_created": 0,
    "google_searches": 0,
    "start_time": datetime.now().isoformat(),
    "user_states": {}
}

# ==================== GOOGLE SEARCH API ====================
class GoogleSearchAPI:
    def __init__(self):
        self.api_key = GOOGLE_API_KEY
        self.cse_id = GOOGLE_CSE_ID
        self.base_url = "https://www.googleapis.com/customsearch/v1"
        self.cache = {}
        
    def search(self, query, num_results=5):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Google Custom Search API"""
        if not query or len(query.strip()) < 2:
            return self._create_empty_result(query)
        
        cache_key = f"{query}_{num_results}"
        if cache_key in self.cache:
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é –∫—ç—à –¥–ª—è: {query}")
            return self.cache[cache_key]
        
        stats["google_searches"] += 1
        
        params = {
            "key": self.api_key,
            "cx": self.cse_id,
            "q": query,
            "num": min(num_results, 5),
            "hl": "ru",
            "lr": "lang_ru",
            "gl": "ru"
        }
        
        try:
            logger.info(f"–í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫ Google: {query}")
            response = requests.get(self.base_url, params=params, timeout=10)
            
            if response.status_code != 200:
                logger.warning(f"–û—à–∏–±–∫–∞ API {response.status_code}, –∏—Å–ø–æ–ª—å–∑—É—é fallback")
                return self._create_fallback_result(query, response.status_code)
            
            data = response.json()
            result = self._parse_search_results(data, query)
            self.cache[cache_key] = result
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")
            return self._create_fallback_result(query, str(e))
    
    def _parse_search_results(self, data, query):
        """–ü–∞—Ä—Å–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞"""
        items = []
        all_text = ""
        
        if "items" in data:
            for item in data["items"]:
                title = item.get("title", "")
                snippet = item.get("snippet", "")
                link = item.get("link", "")
                source = item.get("displayLink", "")
                
                # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç
                title = self._clean_text(title)
                snippet = self._clean_text(snippet)
                
                # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                all_text += f"{title} {snippet} "
                
                items.append({
                    "title": title,
                    "snippet": snippet,
                    "link": link,
                    "source": source,
                    "full_text": f"{title}. {snippet}"
                })
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É
        topic_info = self._analyze_topic(query, all_text, items)
        
        return {
            "success": True,
            "query": query,
            "items": items,
            "total": len(items),
            "topic_info": topic_info,
            "all_text": all_text[:2000],
            "timestamp": datetime.now().isoformat()
        }
    
    def _clean_text(self, text):
        """–û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        if not text:
            return ""
        # –£–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        text = re.sub(r'<[^>]+>', '', text)
        text = re.sub(r'\s+', ' ', text)
        return text.strip()
    
    def _analyze_topic(self, query, all_text, items):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞"""
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        categories = {
            "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": ["—Ç–µ—Ö–Ω–æ–ª–æ–≥", "–∏–∏", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω", "–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä", "–∫–æ–º–ø—å—é—Ç–µ—Ä", "—Ä–æ–±–æ—Ç", "—Å–æ—Ñ—Ç", "–∞–ø–ø–∞—Ä–∞—Ç", "–≥–∞–¥–∂–µ—Ç"],
            "—ç–∫–æ–Ω–æ–º–∏–∫–∞": ["—ç–∫–æ–Ω–æ–º–∏–∫", "—Ñ–∏–Ω–∞–Ω—Å", "—Ä—ã–Ω–æ–∫", "–±–∏–∑–Ω–µ—Å", "–∏–Ω—Ñ–ª—è—Ü", "–≤–∞–ª—é—Ç–∞", "–±–∞–Ω–∫", "–∏–Ω–≤–µ—Å—Ç–∏—Ü", "–∫—Ä–∏–∑–∏—Å", "–¥–µ–Ω—å–≥"],
            "–Ω–∞—É–∫–∞": ["–Ω–∞—É–∫", "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω", "—É—á–µ–Ω", "—Ñ–∏–∑–∏–∫", "—Ö–∏–º–∏", "–±–∏–æ–ª–æ–≥", "–∫–æ—Å–º–æ—Å", "–æ—Ç–∫—Ä—ã—Ç", "—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç", "—Ç–µ–æ—Ä–∏—è"],
            "–º–µ–¥–∏—Ü–∏–Ω–∞": ["–º–µ–¥–∏—Ü–∏–Ω", "–∑–¥–æ—Ä–æ–≤", "–±–æ–ª–µ–∑–Ω", "–ª–µ—á–µ–Ω", "–≤—Ä–∞—á", "–±–æ–ª—å–Ω–∏—Ü", "–≤–∏—Ä—É—Å", "–≤–∞–∫—Ü–∏–Ω", "–æ–ø–µ—Ä–∞—Ü", "–¥–∏–∞–≥–Ω–æ—Å—Ç"],
            "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": ["–æ–±—Ä–∞–∑–æ–≤–∞–Ω", "–æ–±—É—á–µ–Ω", "—à–∫–æ–ª", "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "—Å—Ç—É–¥–µ–Ω—Ç", "–ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω", "–∫—É—Ä—Å", "—ç–∫–∑–∞–º–µ–Ω", "–¥–∏–ø–ª–æ–º", "–∑–Ω–∞–Ω"],
            "–ø–æ–ª–∏—Ç–∏–∫–∞": ["–ø–æ–ª–∏—Ç–∏–∫", "–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤", "–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤", "–ø–∞—Ä–ª–∞–º–µ–Ω—Ç", "–≤—ã–±–æ—Ä", "–∑–∞–∫–æ–Ω", "–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–º–∏–Ω–∏—Å—Ç—Ä", "–ø–∞—Ä—Ç–∏—è", "–¥–µ–º–æ–∫—Ä–∞—Ç"],
            "–∏—Å—Ç–æ—Ä–∏—è": ["–∏—Å—Ç–æ—Ä–∏", "–≤–æ–π–Ω", "—Å—Ä–∞–∂–µ–Ω", "–¥—Ä–µ–≤–Ω", "—Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤", "—Ä–µ–≤–æ–ª—é—Ü", "–∏–º–ø–µ—Ä–∏", "–∫–æ—Ä–æ–ª—å", "—Ü–∞—Ä—å", "–∞—Ä—Ö–µ–æ–ª–æ–≥"],
            "–∫—É–ª—å—Ç—É—Ä–∞": ["–∫—É–ª—å—Ç—É—Ä", "–∏—Å–∫—É—Å—Å—Ç–≤", "–º—É–∑—ã–∫", "–∫–∏–Ω–æ", "—Ç–µ–∞—Ç—Ä", "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä", "—Ö—É–¥–æ–∂–Ω–∏–∫", "–ø–∏—Å–∞—Ç–µ–ª—å", "–∞—Ä—Ç", "–≤—ã—Å—Ç–∞–≤–∫"],
            "—Å–ø–æ—Ä—Ç": ["—Å–ø–æ—Ä—Ç", "—Ñ—É—Ç–±–æ–ª", "—Ö–æ–∫–∫–µ–π", "–±–∞—Å–∫–µ—Ç–±–æ–ª", "–æ–ª–∏–º–ø–∏–π—Å–∫", "—á–µ–º–ø–∏–æ–Ω–∞—Ç", "–∏–≥—Ä–æ–∫", "—Ç—Ä–µ–Ω–µ—Ä", "—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω", "–º–µ–¥–∞–ª—å"]
        }
        
        query_lower = query.lower()
        all_text_lower = all_text.lower()
        
        detected_category = "–æ–±—â–∞—è —Ç–µ–º–∞"
        category_score = 0
        
        for category, keywords in categories.items():
            score = 0
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∑–∞–ø—Ä–æ—Å–µ
            for keyword in keywords:
                if keyword in query_lower:
                    score += 2
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ç–µ–∫—Å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            for keyword in keywords:
                if keyword in all_text_lower:
                    score += 1
            
            if score > category_score:
                category_score = score
                detected_category = category
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        keywords = self._extract_keywords(all_text)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        complexity = "–±–∞–∑–æ–≤–∞—è"
        if len(items) > 3 and len(all_text) > 500:
            complexity = "—Å—Ä–µ–¥–Ω—è—è"
        if len(items) > 5 and len(all_text) > 1000:
            complexity = "—Å–ª–æ–∂–Ω–∞—è"
        
        return {
            "category": detected_category,
            "keywords": keywords[:10],
            "complexity": complexity,
            "has_data": len(items) > 0,
            "sources_count": len(items)
        }
    
    def _extract_keywords(self, text):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        stop_words = {
            "–∏", "–≤", "–Ω–∞", "—Å", "–ø–æ", "–æ", "–æ–±", "–¥–ª—è", "–∏–∑", "–æ—Ç", "—ç—Ç–æ", "—á—Ç–æ", 
            "–∫–∞–∫", "–Ω–æ", "–∞", "–∏–ª–∏", "–µ—Å–ª–∏", "—Ç–æ", "–∂–µ", "–±—ã", "–ª–∏", "–Ω–µ—Ç", "–¥–∞",
            "–æ–Ω", "–æ–Ω–∞", "–æ–Ω–æ", "–æ–Ω–∏", "–º—ã", "–≤—ã", "—Ç—ã", "—è", "–º–µ–Ω—è", "—Ç–µ–±—è", "–µ–≥–æ", "–µ–µ"
        }
        
        # –ù–∞—Ö–æ–¥–∏–º —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞ –æ—Ç 3 –±—É–∫–≤
        words = re.findall(r'\b[–∞-—è—ë]{3,}\b', text.lower())
        
        # –°—á–∏—Ç–∞–µ–º —á–∞—Å—Ç–æ—Ç—É
        word_freq = {}
        for word in words:
            if word not in stop_words:
                word_freq[word] = word_freq.get(word, 0) + 1
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
        sorted_words = sorted(word_freq.items(), key=lambda x: x[1], reverse=True)
        return [word for word, freq in sorted_words[:15]]
    
    def _create_fallback_result(self, query, error):
        """–°–æ–∑–¥–∞–µ—Ç fallback-—Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
        logger.info(f"–°–æ–∑–¥–∞—é fallback –¥–ª—è: {query}")
        
        # –ë–∞–∑–æ–≤—ã–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        topic_data = {
            "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": {
                "title": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏",
                "description": "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è, –≤–ª–∏—è—è –Ω–∞ –≤—Å–µ —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏. –ö–ª—é—á–µ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫—É –∏ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.",
                "aspects": ["–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–†–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞", "–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–ë–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ", "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–µ—â–µ–π"]
            },
            "—ç–∫–æ–Ω–æ–º–∏–∫–∞": {
                "title": "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ —Ä—ã–Ω–∫–∏",
                "description": "–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏–∑—É—á–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö.",
                "aspects": ["–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞", "–ú–∏–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä—ã–Ω–∫–∏", "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è", "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç"]
            },
            "–Ω–∞—É–∫–∞": {
                "title": "–ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è",
                "description": "–ù–∞—É–∫–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑—É—á–∞–µ—Ç –æ–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä —á–µ—Ä–µ–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã. –ù–∞—É—á–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –∑–Ω–∞–Ω–∏—è.",
                "aspects": ["–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "–ü—Ä–∏–∫–ª–∞–¥–Ω–∞—è –Ω–∞—É–∫–∞", "–ú–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã", "–ù–∞—É—á–Ω—ã–π –º–µ—Ç–æ–¥", "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"]
            },
            "–æ–±—â–∞—è —Ç–µ–º–∞": {
                "title": f"–ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã: {query}",
                "description": f"–¢–µ–º–∞ '{query}' –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –ø–æ–¥—Ö–æ–¥—ã –∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.",
                "aspects": ["–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è", "–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã", "–ú–µ—Ç–æ–¥—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ", "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è"]
            }
        }
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        detected_category = "–æ–±—â–∞—è —Ç–µ–º–∞"
        for category in ["—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "—ç–∫–æ–Ω–æ–º–∏–∫–∞", "–Ω–∞—É–∫–∞"]:
            if category in query.lower():
                detected_category = category
                break
        
        data = topic_data[detected_category]
        
        items = [{
            "title": data["title"],
            "snippet": data["description"],
            "full_text": data["description"],
            "source": "–ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π",
            "aspects": data["aspects"]
        }]
        
        return {
            "success": False,
            "query": query,
            "items": items,
            "total": 1,
            "topic_info": {
                "category": detected_category,
                "keywords": query.lower().split()[:5],
                "complexity": "–±–∞–∑–æ–≤–∞—è",
                "has_data": True,
                "sources_count": 1,
                "fallback": True,
                "error": str(error)[:100]
            },
            "all_text": data["description"],
            "timestamp": datetime.now().isoformat()
        }
    
    def _create_empty_result(self, query):
        """–°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
        return {
            "success": False,
            "query": query,
            "items": [],
            "total": 0,
            "topic_info": {
                "category": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                "keywords": [],
                "complexity": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞",
                "has_data": False,
                "sources_count": 0
            },
            "all_text": "",
            "timestamp": datetime.now().isoformat()
        }

# ==================== –ì–ï–ù–ï–†–ê–¢–û–† –ö–û–ù–°–ü–ï–ö–¢–û–í (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ====================
class ConspectGenerator:
    def __init__(self):
        self.searcher = GoogleSearchAPI()
        logger.info("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def generate(self, topic, volume="short"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Å—Ö–∞–ª–∫–∏
        if self._is_easter_egg(topic):
            return self._create_easter_egg_response()
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        search_results = self.searcher.search(topic)
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {search_results['total']}")
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞
        if volume == "detailed":
            return self._generate_detailed(topic, search_results)
        elif volume == "extended":
            return self._generate_extended(topic, search_results)
        else:  # short
            return self._generate_short(topic, search_results)
    
    def _is_easter_egg(self, text):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Å—Ö–∞–ª–∫–∏"""
        text_lower = text.lower()
        return any(phrase in text_lower for phrase in [
            "–ø–ª–∞–Ω –∑–∞—Ö–≤–∞—Ç–∞ –ø–æ–ª—å—à–∏", "–∑–∞—Ö–≤–∞—Ç –ø–æ–ª—å—à–∏", "—á–∞–π–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞"
        ])
    
    def _create_easter_egg_response(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø–∞—Å—Ö–∞–ª–∫–∏"""
        responses = [
            "üçµ *–°–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!*\n\n–ß–∞–π–Ω—ã–π —Å—Ç–∞—Ç—É—Å: –ê–ö–¢–ò–í–ï–ù\n–§–æ–∫—Å—è –≤ –ø—É—Ç–∏...",
            "üçµ *Easter Egg Found!*\n\nTea Status: ACTIVE\nFoksya is coming..."
        ]
        return random.choice(responses)
    
    def _generate_short(self, topic, results):
        """–ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)"""
        topic_info = results.get("topic_info", {})
        items = results.get("items", [])
        
        conspect = f"üìÑ *–ö–û–ù–°–ü–ï–ö–¢: {topic.upper()}*\n\n"
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∏—Å–∫–µ
        conspect += f"üîç *–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* {topic_info.get('category', '–æ–±—â–∞—è —Ç–µ–º–∞')}\n"
        conspect += f"üìä *–ù–∞–π–¥–µ–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:* {results['total']}\n"
        conspect += f"‚ö° *–°–ª–æ–∂–Ω–æ—Å—Ç—å:* {topic_info.get('complexity', '–±–∞–∑–æ–≤–∞—è')}\n\n"
        
        # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞)
        conspect += "üìù *–û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:*\n\n"
        
        if items:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–∏—Å–∫–∞
            for i, item in enumerate(items[:3], 1):
                text = item.get("full_text", item.get("snippet", ""))
                if text:
                    conspect += f"{i}. {text}\n\n"
        else:
            # Fallback —Ç–µ–∫—Å—Ç —Å —É—á–µ—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            category = topic_info.get("category", "–æ–±—â–∞—è —Ç–µ–º–∞")
            descriptions = {
                "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è, –º–µ–Ω—è—è –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ –∏ —Ä–∞–±–æ—Ç—ã –ª—é–¥–µ–π.",
                "—ç–∫–æ–Ω–æ–º–∏–∫–∞": "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤—Å–µ —Å—Ñ–µ—Ä—ã –æ–±—â–µ—Å—Ç–≤–∞.",
                "–Ω–∞—É–∫–∞": "–ù–∞—É—á–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–∞—Å—à–∏—Ä—è—é—Ç –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–∑–Ω–∞–Ω–∏—è –∏ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.",
                "–º–µ–¥–∏—Ü–∏–Ω–∞": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ —É–ª—É—á—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏.",
                "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –∫ –≤—ã–∑–æ–≤–∞–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∏—Ä–∞."
            }
            conspect += f"üìå {descriptions.get(category, '–¢–µ–º–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.')}\n\n"
        
        # –ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã
        conspect += "üéØ *–ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´:*\n"
        
        keywords = topic_info.get("keywords", [])
        if keywords:
            for i, keyword in enumerate(keywords[:5], 1):
                conspect += f"{i}. {keyword.capitalize()}\n"
        else:
            aspects = [
                "–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è",
                "–ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏",
                "–ó–Ω–∞—á–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
                "–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è",
                "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å"
            ]
            for i, aspect in enumerate(aspects, 1):
                conspect += f"{i}. {aspect}\n"
        
        # –í—ã–≤–æ–¥—ã
        conspect += f"\nüí° *–í–´–í–û–î:* –¢–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n"
        conspect += "ü§ñ *@Konspekt_help_bot* | üîç *Google Search API*"
        
        return conspect
    
    def _generate_detailed(self, topic, results):
        """–ü–æ–¥—Ä–æ–±–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)"""
        topic_info = results.get("topic_info", {})
        items = results.get("items", [])
        
        conspect = f"üìö *–ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó: {topic.upper()}*\n\n"
        
        # –í–≤–µ–¥–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–∏—Å–∫–µ
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üìã *–í–í–ï–î–ï–ù–ò–ï –ò –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        conspect += f"*–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:* {topic}\n"
        conspect += f"*–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–∞:* {topic_info.get('category', '–æ–±—â–∞—è —Ç–µ–º–∞')}\n"
        conspect += f"*–û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö:* {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n"
        conspect += f"*–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ–º—ã:* {topic_info.get('complexity', '–±–∞–∑–æ–≤–∞—è')}\n"
        conspect += f"*–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:* {datetime.now().strftime('%H:%M')}\n\n"
        
        # –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–∏—Å–∫–∞)
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üî¨ *–ê–ù–ê–õ–ò–ó –ò–°–¢–û–ß–ù–ò–ö–û–í*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        if items:
            for i, item in enumerate(items, 1):
                title = item.get("title", f"–ò—Å—Ç–æ—á–Ω–∏–∫ {i}")
                text = item.get("full_text", item.get("snippet", ""))
                source = item.get("source", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫")
                
                conspect += f"**{i}. {title}**\n"
                conspect += f"{text}\n"
                conspect += f"*–ò—Å—Ç–æ—á–Ω–∏–∫:* {source}\n\n"
        else:
            conspect += "*–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:* –î–ª—è –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.\n\n"
        
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üèó *–°–¢–†–£–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        keywords = topic_info.get("keywords", [])
        
        if keywords:
            conspect += "*–ö–õ–Æ–ß–ï–í–´–ï –ö–û–ù–¶–ï–ü–¶–ò–ò:*\n\n"
            for i, keyword in enumerate(keywords[:8], 1):
                # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
                descriptions = {
                    "—Ç–µ—Ö–Ω–æ–ª–æ–≥": "–ò–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—É—á–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á",
                    "—ç–∫–æ–Ω–æ–º–∏–∫": "–ù–∞—É–∫–∞ –æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥",
                    "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω": "–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–Ω–∞–Ω–∏–π",
                    "—Ä–∞–∑–≤–∏—Ç–∏": "–ü—Ä–æ—Ü–µ—Å—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è, –≤–µ–¥—É—â–∏–π –∫ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è–º",
                    "—Å–æ–≤—Ä–µ–º–µ–Ω–Ω": "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —è–≤–ª–µ–Ω–∏–π –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞"
                }
                
                description = descriptions.get(keyword[:8], "–í–∞–∂–Ω—ã–π –∞—Å–ø–µ–∫—Ç, —Ç—Ä–µ–±—É—é—â–∏–π –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è")
                conspect += f"{i}. **{keyword.capitalize()}** - {description}\n"
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            structures = {
                "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": [
                    "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã",
                    "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–µ—à–µ–Ω–∏—è",
                    "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è",
                    "–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è",
                    "–≠—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã"
                ],
                "—ç–∫–æ–Ω–æ–º–∏–∫–∞": [
                    "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏",
                    "–†—ã–Ω–æ—á–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã",
                    "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã",
                    "–ü—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞–∑–≤–∏—Ç–∏—è"
                ],
                "–Ω–∞—É–∫–∞": [
                    "–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ö–æ–¥—ã",
                    "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã",
                    "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã",
                    "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
                    "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π"
                ]
            }
            
            category = topic_info.get("category", "–æ–±—â–∞—è —Ç–µ–º–∞")
            aspects = structures.get(category, [
                "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã",
                "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã",
                "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
                "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
                "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è"
            ])
            
            conspect += "*–û–°–ù–û–í–ù–´–ï –†–ê–ó–î–ï–õ–´ –ê–ù–ê–õ–ò–ó–ê:*\n\n"
            for i, aspect in enumerate(aspects, 1):
                conspect += f"{i}. **{aspect}** - —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–º—ã\n"
        
        # –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        conspect += f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üíé *–í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        conspect += "–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–≤–æ–¥—ã:\n\n"
        
        conclusions = [
            "–¢–µ–º–∞ –æ–±–ª–∞–¥–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è",
            "–°—É—â–µ—Å—Ç–≤—É—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞",
            "–ò–º–µ—é—Ç—Å—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
        ]
        
        for i, conclusion in enumerate(conclusions, 1):
            conspect += f"{i}. {conclusion}\n"
        
        conspect += f"\n*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è:*\n"
        conspect += "1. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
        conspect += "2. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤\n"
        conspect += "3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è\n"
        
        conspect += f"\nüìä *–í—Å–µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:* {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n"
        conspect += f"ü§ñ *–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ @Konspekt_help_bot*\n"
        conspect += f"üîç *–° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Google Search API*"
        
        return conspect
    
    def _generate_extended(self, topic, results):
        """–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)"""
        topic_info = results.get("topic_info", {})
        items = results.get("items", [])
        
        conspect = f"üìñ *–ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï: {topic.upper()}*\n\n"
        
        # –ß–∞—Å—Ç—å 1: –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 1: –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ò –ò–°–¢–û–ß–ù–ò–ö–ò\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += f"**–ù–ê–ó–í–ê–ù–ò–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:** –ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã ¬´{topic}¬ª\n\n"
        
        conspect += "**–¶–ï–õ–¨ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n"
        conspect += "–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ, —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥—ã.\n\n"
        
        conspect += "**–ó–ê–î–ê–ß–ò –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n"
        tasks = [
            f"–°–æ–±—Ä–∞—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª",
            "–í—ã—è–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –ø–æ–Ω—è—Ç–∏—è",
            "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏ –ø–æ–¥—Ö–æ–¥—ã",
            "–°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
            "–°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"
        ]
        
        for i, task in enumerate(tasks, 1):
            conspect += f"{i}. {task}\n"
        
        conspect += f"\n**–ú–ï–¢–û–î–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –û–°–ù–û–í–ê:**\n"
        conspect += "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤. "
        conspect += f"–ë—ã–ª–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Google Custom Search API.\n\n"
        
        conspect += "**–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –¢–ï–ú–´:**\n"
        conspect += f"‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {topic_info.get('category', '–æ–±—â–∞—è —Ç–µ–º–∞')}\n"
        conspect += f"‚Ä¢ –°–ª–æ–∂–Ω–æ—Å—Ç—å: {topic_info.get('complexity', '–±–∞–∑–æ–≤–∞—è')}\n"
        conspect += f"‚Ä¢ –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö: {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n"
        conspect += f"‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Ö–≤–∞—Ç: –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n"
        
        # –ß–∞—Å—Ç—å 2: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 2: –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–ë–ó–û–†\n"
        conspect += "=" * 50 + "\n\n"
        
        if items:
            conspect += "**–û–ë–ó–û–† –ò–°–¢–û–ß–ù–ò–ö–û–í –ò–ù–§–û–†–ú–ê–¶–ò–ò:**\n\n"
            
            for i, item in enumerate(items, 1):
                title = item.get("title", f"–ò—Å—Ç–æ—á–Ω–∏–∫ {i}")
                text = item.get("full_text", item.get("snippet", ""))
                source = item.get("source", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫")
                
                conspect += f"**{i}. {title}**\n"
                conspect += f"*–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:* {text}\n"
                conspect += f"*–ò—Å—Ç–æ—á–Ω–∏–∫:* {source}\n"
                conspect += f"*–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–Ω–æ—Å–∏—Ç –≤–∫–ª–∞–¥ –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–º—ã –∏ —Ç—Ä–µ–±—É–µ—Ç —É—á–µ—Ç–∞ –≤ –æ–±—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.\n\n"
        else:
            conspect += "**–û–°–û–ë–ï–ù–ù–û–°–¢–ò –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ô –ë–ê–ó–´:**\n"
            conspect += "–î–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.\n\n"
        
        # –ß–∞—Å—Ç—å 3: –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 3: –ö–û–ù–¶–ï–ü–¢–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–ö–õ–Æ–ß–ï–í–´–ï –ü–û–ù–Ø–¢–ò–Ø –ò –¢–ï–†–ú–ò–ù–´:**\n\n"
        
        keywords = topic_info.get("keywords", [])
        if keywords:
            for i, keyword in enumerate(keywords[:12], 1):
                # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
                term_descriptions = {
                    "–∞–Ω–∞–ª–∏–∑": "–ü—Ä–æ—Ü–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—É—Ç–µ–º —Ä–∞–∑–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —á–∞—Å—Ç–∏",
                    "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": "–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤",
                    "—Ä–∞–∑–≤–∏—Ç–∏–µ": "–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥–∞ –æ—Ç –æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫ –¥—Ä—É–≥–æ–º—É",
                    "—Å–∏—Å—Ç–µ–º–∞": "–°–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ —Å–≤—è–∑—è—Ö –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º",
                    "–º–µ—Ç–æ–¥": "–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏, —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏",
                    "–ø–æ–¥—Ö–æ–¥": "–°–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–µ–º–æ–≤, —Å–ø–æ—Å–æ–±–æ–≤ –≤ –∏–∑—É—á–µ–Ω–∏–∏, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —á–µ–≥–æ-–ª–∏–±–æ",
                    "–∫–æ–Ω—Ü–µ–ø—Ü–∏—è": "–°–∏—Å—Ç–µ–º–∞ –≤–∑–≥–ª—è–¥–æ–≤, —Ç–æ –∏–ª–∏ –∏–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —è–≤–ª–µ–Ω–∏–π, –ø—Ä–æ—Ü–µ—Å—Å–æ–≤",
                    "–º–æ–¥–µ–ª—å": "–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã",
                    "—Ç–µ–æ—Ä–∏—è": "–°–∏—Å—Ç–µ–º–∞ –æ–±–æ–±—â–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞–Ω–∏—è, –æ–±—ä—è—Å–Ω—è—é—â–∞—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è",
                    "–ø—Ä–∞–∫—Ç–∏–∫–∞": "–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö"
                }
                
                description = term_descriptions.get(keyword[:8], 
                    "–í–∞–∂–Ω–æ–µ –ø–æ–Ω—è—Ç–∏–µ, —Ç—Ä–µ–±—É—é—â–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è")
                conspect += f"{i}. **{keyword.capitalize()}** ‚Äî {description}\n\n"
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–Ω—è—Ç–∏–π
            concepts = [
                ("–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞", "–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –ª–µ–∂–∞—â–∏–µ –≤ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã"),
                ("–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥", "–°–ø–æ—Å–æ–±—ã –∏ –º–µ—Ç–æ–¥—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ –ø—Ä–∏ –∏–∑—É—á–µ–Ω–∏–∏ —Ç–µ–º—ã"),
                ("–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ", "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö"),
                ("–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å", "–°—Ö–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π"),
                ("–û—Ü–µ–Ω–æ—á–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏", "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"),
                ("–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è", "–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è")
            ]
            
            for i, (concept, desc) in enumerate(concepts, 1):
                conspect += f"{i}. **{concept}** ‚Äî {desc}\n\n"
        
        # –ß–∞—Å—Ç—å 4: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 4: –°–¢–†–£–ö–¢–£–†–ù–´–ï –ê–°–ü–ï–ö–¢–´ –¢–ï–ú–´\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–û–°–ù–û–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n\n"
        
        research_directions = [
            {
                "name": "–¢–µ–æ—Ä–µ—Ç–∏–∫–æ-–º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç",
                "description": "–ò–∑—É—á–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å–Ω–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é —Ç–µ–º—ã"
            },
            {
                "name": "–ò—Å—Ç–æ—Ä–∏–∫–æ-–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
                "description": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è, —Ä–∞–∑–≤–∏—Ç–∏—è –∏ —ç–≤–æ–ª—é—Ü–∏–∏ —Ç–µ–º—ã –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ"
            },
            {
                "name": "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ-—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ",
                "description": "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤, –∫–æ–Ω—Ü–µ–ø—Ü–∏–π –∏ —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è –Ω–∞ —Ç–µ–º—É"
            },
            {
                "name": "–ü—Ä–∞–∫—Ç–∏–∫–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥",
                "description": "–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–π –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π"
            },
            {
                "name": "–ü—Ä–æ–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
                "description": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤ –∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–∞–∑–≤–∏—Ç–∏—è"
            }
        ]
        
        for direction in research_directions:
            conspect += f"‚Ä¢ **{direction['name']}**\n"
            conspect += f"  {direction['description']}. –î–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è.\n\n"
        
        # –ß–∞—Å—Ç—å 5: –í—ã–≤–æ–¥—ã –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 5: –í–´–í–û–î–´ –ò –ü–ï–†–°–ü–ï–ö–¢–ò–í–´\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–û–°–ù–û–í–ù–´–ï –í–´–í–û–î–´ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n\n"
        
        research_conclusions = [
            f"–¢–µ–º–∞ ¬´{topic}¬ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, —Ç—Ä–µ–±—É—é—â—É—é –º–Ω–æ–≥–æ–∞—Å–ø–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è",
            "–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã—è–≤–∏–ª –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–π –∏–∑—É—á–µ–Ω–∏—è",
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –±–∞–∑–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ —É–≥–ª—É–±–ª–µ–Ω–∏—è",
            "–í—ã—è–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ —Ç–µ—Ä–º–∏–Ω—ã, —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç —Ç–µ–º—ã",
            "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∏–∑—É—á–∞–µ–º–æ–π –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∏"
        ]
        
        for i, conclusion in enumerate(research_conclusions, 1):
            conspect += f"{i}. {conclusion}\n"
        
        conspect += f"\n**–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**\n\n"
        
        recommendations = [
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–º—ã —Å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
            "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤",
            "–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–Ω–∞–Ω–∏–π –ø–æ —Ç–µ–º–µ",
            "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –ø–æ –¥–∞–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–µ",
            "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –∏ –≤—ã–≤–æ–¥–æ–≤"
        ]
        
        for i, recommendation in enumerate(recommendations, 1):
            conspect += f"{i}. {recommendation}\n"
        
        conspect += f"\n**–ü–ï–†–°–ü–ï–ö–¢–ò–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –î–ê–õ–¨–ù–ï–ô–®–ï–ì–û –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n\n"
        
        future_directions = [
            "–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã",
            "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –æ–ø—ã—Ç–∞",
            "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –∏–∑—É—á–µ–Ω–∏—é",
            "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–π",
            "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–π –∏ –∫–µ–π—Å–æ–≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏"
        ]
        
        for direction in future_directions:
            conspect += f"‚Ä¢ {direction}\n"
        
        # –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
        conspect += f"\n" + "=" * 50 + "\n"
        conspect += "–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += f"–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª –ø–æ–∑–≤–æ–ª–∏–ª–æ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö, –ø–æ–¥—Ö–æ–¥–∞—Ö –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞—Ö –∏–∑—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∏.\n\n"
        
        conspect += "**–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:**\n"
        conspect += f"‚Ä¢ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: {datetime.now().strftime('%d.%m.%Y')}\n"
        conspect += f"‚Ä¢ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%H:%M')}\n"
        conspect += f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {results['total']}\n"
        conspect += f"‚Ä¢ –û–±—ä–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ~{len(conspect)//1000}K —Å–∏–º–≤–æ–ª–æ–≤\n"
        conspect += f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: Google Custom Search API\n"
        conspect += f"‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞: @Konspekt_help_bot\n\n"
        
        conspect += "¬© –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –î–ª—è —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º."
        
        return conspect

# ==================== TELEGRAM BOT ====================
class TelegramBot:
    def __init__(self):
        if not TELEGRAM_TOKEN:
            raise ValueError("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        self.token = TELEGRAM_TOKEN
        self.bot_url = f"https://api.telegram.org/bot{self.token}"
        self.generator = ConspectGenerator()
        
        if RENDER_EXTERNAL_URL:
            self._setup_webhook()
        
        logger.info("‚úÖ Telegram –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _setup_webhook(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫"""
        webhook_url = f"{RENDER_EXTERNAL_URL}/webhook"
        try:
            response = requests.post(
                f"{self.bot_url}/setWebhook",
                json={"url": webhook_url},
                timeout=10
            )
            if response.json().get("ok"):
                logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
    
    def process_message(self, chat_id, text):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        text = text.strip()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self._update_stats(chat_id)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        if text.startswith("/"):
            if text == "/start":
                return self._send_welcome(chat_id)
            elif text == "/help":
                return self._send_help(chat_id)
            elif text == "/stats":
                return self._send_stats(chat_id)
            else:
                return self._send_message(chat_id, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help")
        
        # –í—ã–±–æ—Ä –æ–±—ä–µ–º–∞ (1, 2, 3)
        if text in ["1", "2", "3"]:
            return self._handle_volume(chat_id, text)
        
        # –ù–æ–≤–∞—è —Ç–µ–º–∞
        return self._handle_topic(chat_id, text)
    
    def _send_welcome(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
        welcome = (
            "üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Konspekt Helper Bot!*\n\n"
            "ü§ñ *–Ø —Å–æ–∑–¥–∞—é –∫–æ–Ω—Å–ø–µ–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ Google!*\n\n"
            "üöÄ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
            "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–∞:\n"
            "   ‚Ä¢ *1* ‚Äî –ö—Ä–∞—Ç–∫–∏–π (–∫–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã)\n"
            "   ‚Ä¢ *2* ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π (—Å –∞–Ω–∞–ª–∏–∑–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)\n"
            "   ‚Ä¢ *3* ‚Äî –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π (–ø–æ–ª–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)\n"
            "3. –ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç\n\n"
            "üîç *–ò—Å–ø–æ–ª—å–∑—É—é Google Custom Search API*\n"
            "üìä *–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏*\n\n"
            "üéØ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –Ω–∞—á–∞–ª–∞!*"
        )
        return self._send_message(chat_id, welcome)
    
    def _send_help(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–∫—É"""
        help_text = (
            "üìö *–°–ü–†–ê–í–ö–ê –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –ë–û–¢–ê*\n\n"
            "*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
            "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
            "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
            "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞\n\n"
            "*–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:*\n"
            "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç')\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ —Ü–∏—Ñ—Ä—É 1, 2 –∏–ª–∏ 3\n"
            "3. –ü–æ–ª—É—á–∏—Ç–µ –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞ Google\n\n"
            "*–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:*\n"
            "‚Ä¢ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\n"
            "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∏–º–∞—Ç–∞\n"
            "‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞\n"
            "‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
        )
        return self._send_message(chat_id, help_text)
    
    def _send_stats(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        stat_text = (
            f"üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê*\n\n"
            f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: {stats['total_messages']}\n"
            f"üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤: {stats['conspects_created']}\n"
            f"üîç –ü–æ–∏—Å–∫–æ–≤ Google: {stats['google_searches']}\n"
            f"‚è± –ó–∞–ø—É—â–µ–Ω: {stats['start_time'][:10]}\n\n"
            f"üåê –•–æ—Å—Ç–∏–Ω–≥: Render.com\n"
            f"üîó URL: {RENDER_EXTERNAL_URL}"
        )
        return self._send_message(chat_id, stat_text)
    
    def _handle_topic(self, chat_id, topic):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Ç–µ–º—É"""
        user_id = str(chat_id)
        if user_id not in stats["user_states"]:
            stats["user_states"][user_id] = {}
        
        stats["user_states"][user_id]["pending_topic"] = topic
        
        response = (
            f"üéØ *–¢–ï–ú–ê –ü–†–ò–ù–Ø–¢–ê: {topic}*\n\n"
            f"‚úÖ –ì–æ—Ç–æ–≤–ª—é –ø–æ–∏—Å–∫ –≤ Google...\n\n"
            f"üìä *–í–´–ë–ï–†–ò–¢–ï –û–ë–™–ï–ú –ö–û–ù–°–ü–ï–ö–¢–ê:*\n\n"
            f"1Ô∏è‚É£ *–ö–†–ê–¢–ö–ò–ô*\n–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã –∏ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã\n\n"
            f"2Ô∏è‚É£ *–ü–û–î–†–û–ë–ù–´–ô*\n–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã\n\n"
            f"3Ô∏è‚É£ *–†–ê–ó–í–ï–†–ù–£–¢–´–ô*\n–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏\n\n"
            f"üî¢ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–∏—Ñ—Ä—É 1, 2 –∏–ª–∏ 3*"
        )
        return self._send_message(chat_id, response)
    
    def _handle_volume(self, chat_id, volume_choice):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –æ–±—ä–µ–º–∞"""
        user_id = str(chat_id)
        user_state = stats["user_states"].get(user_id, {})
        topic = user_state.get("pending_topic", "")
        
        if not topic:
            return self._send_message(chat_id, "‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –ø–æ–∏—Å–∫–∞")
        
        volume_map = {"1": "short", "2": "detailed", "3": "extended"}
        volume = volume_map.get(volume_choice, "short")
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        self._send_message(
            chat_id, 
            f"üîç *–í–´–ü–û–õ–ù–Ø–Æ –ü–û–ò–°–ö –í GOOGLE...*\n\n"
            f"üìå –¢–µ–º–∞: {topic}\n"
            f"üìä –û–±—ä–µ–º: {volume_choice}/3\n\n"
            f"‚è≥ –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥..."
        )
        
        try:
            conspect = self.generator.generate(topic, volume)
            stats["conspects_created"] += 1
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∫–æ–Ω—Å–ø–µ–∫—Ç–∞
            if len(conspect) <= 4096:
                self._send_message(chat_id, conspect)
            else:
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                parts = [conspect[i:i+4000] for i in range(0, len(conspect), 4000)]
                for i, part in enumerate(parts, 1):
                    if i == 1:
                        self._send_message(chat_id, part)
                    else:
                        import time
                        time.sleep(0.5)
                        self._send_message(chat_id, part)
            
            # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            final_msg = (
                f"‚úÖ *–ö–û–ù–°–ü–ï–ö–¢ –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!*\n\n"
                f"üìå –¢–µ–º–∞: {topic}\n"
                f"üìä –û–±—ä–µ–º: {volume_choice}/3\n"
                f"üîç –ü–æ–∏—Å–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {stats['google_searches']}\n"
                f"üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {stats['conspects_created']}\n\n"
                f"üîÑ *–î—Ä—É–≥–æ–π –æ–±—ä–µ–º –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?* –û—Ç–ø—Ä–∞–≤—å—Ç–µ 1, 2 –∏–ª–∏ 3\n"
                f"üéØ *–ù–æ–≤—ã–π –ø–æ–∏—Å–∫?* –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É!"
            )
            return self._send_message(chat_id, final_msg)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞: {e}")
            return self._send_message(
                chat_id,
                f"‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞*\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.\n\n"
                f"–û—à–∏–±–∫–∞: {str(e)[:100]}"
            )
    
    def _update_stats(self, chat_id):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        user_id = str(chat_id)
        
        if user_id not in stats["user_states"]:
            stats["total_users"] += 1
            stats["user_states"][user_id] = {
                "first_seen": datetime.now().isoformat(),
                "message_count": 0
            }
        
        stats["user_states"][user_id]["last_seen"] = datetime.now().isoformat()
        stats["user_states"][user_id]["message_count"] += 1
        stats["total_messages"] += 1
    
    def _send_message(self, chat_id, text):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            response = requests.post(
                f"{self.bot_url}/sendMessage",
                json={
                    "chat_id": chat_id,
                    "text": text,
                    "parse_mode": "Markdown",
                    "disable_web_page_preview": True
                },
                timeout=10
            )
            return response.json().get("ok", False)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False

# ==================== HTTP –°–ï–†–í–ï–† ====================
class BotHTTPServer(BaseHTTPRequestHandler):
    def do_GET(self):
        path = self.path.split('?')[0]
        
        if path == "/":
            self._send_html(INDEX_HTML)
        elif path == "/health":
            self._send_json({"status": "ok", "time": datetime.now().isoformat()})
        elif path == "/stats":
            self._send_json(stats)
        else:
            self.send_response(404)
            self.end_headers()
    
    def do_POST(self):
        if self.path == "/webhook":
            content_length = int(self.headers.get('Content-Length', 0))
            if content_length:
                try:
                    data = self.rfile.read(content_length)
                    update = json.loads(data.decode('utf-8'))
                    
                    threading.Thread(
                        target=self._handle_update,
                        args=(update,),
                        daemon=True
                    ).start()
                    
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
            
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b'OK')
        else:
            self.send_response(404)
            self.end_headers()
    
    def _handle_update(self, update):
        try:
            if "message" in update and "text" in update["message"]:
                chat_id = update["message"]["chat"]["id"]
                text = update["message"]["text"]
                
                bot = TelegramBot()
                bot.process_message(chat_id, text)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    def _send_html(self, content):
        self.send_response(200)
        self.send_header('Content-Type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(content.encode('utf-8'))
    
    def _send_json(self, data):
        self.send_response(200)
        self.send_header('Content-Type', 'application/json; charset=utf-8')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False, indent=2).encode('utf-8'))
    
    def log_message(self, format, *args):
        pass

# HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
INDEX_HTML = """<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ü§ñ Konspekt Helper Bot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { color: green; font-weight: bold; padding: 10px; background: #e8f5e8; border-radius: 5px; }
        .stat { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .btn { display: inline-block; background: #0088cc; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Konspekt Helper Bot</h1>
        <p class="status">‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–Ω–æ</p>
        <p>Telegram –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞ Google</p>
        
        <div class="stat">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:</h3>
            <div id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <h3>üîó –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:</h3>
        <div>
            <a href="https://t.me/Konspekt_help_bot" class="btn" target="_blank">ü§ñ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
            <a href="/stats" class="btn">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (JSON)</a>
            <a href="/health" class="btn">‚ù§Ô∏è Health Check</a>
        </div>
        
        <h3>üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞:</h3>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/Konspekt_help_bot" target="_blank">@Konspekt_help_bot</a></li>
            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±—É—é —Ç–µ–º—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–∞: 1, 2 –∏–ª–∏ 3</li>
            <li>–ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞ Google</li>
        </ol>
        
        <h3>üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–º—ã –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤:</h3>
        <ul>
            <li><strong>1 ‚Äî –ö—Ä–∞—Ç–∫–∏–π</strong>: –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã –∏ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã</li>
            <li><strong>2 ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π</strong>: –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã</li>
            <li><strong>3 ‚Äî –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π</strong>: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏</li>
        </ul>
        
        <p style="color: #666; font-size: 14px; margin-top: 30px;">
            –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è. –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <span id="time"></span>
        </p>
    </div>
    
    <script>
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();
                
                document.getElementById('stats').innerHTML = `
                    <p>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.total_users || 0}</p>
                    <p>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: ${data.total_messages || 0}</p>
                    <p>üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤: ${data.conspects_created || 0}</p>
                    <p>üîç –ü–æ–∏—Å–∫–æ–≤ Google: ${data.google_searches || 0}</p>
                    <p>‚è± –ó–∞–ø—É—â–µ–Ω: ${data.start_time ? new Date(data.start_time).toLocaleDateString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                `;
                
                document.getElementById('time').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                document.getElementById('stats').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
            }
        }
        
        loadStats();
        setInterval(loadStats, 5000);
    </script>
</body>
</html>
"""

# ==================== –ó–ê–ü–£–°–ö ====================
def main():
    logger.info(f"üåê –í–Ω–µ—à–Ω–∏–π URL: {RENDER_EXTERNAL_URL or '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    logger.info(f"üö™ –ü–æ—Ä—Ç: {PORT}")
    logger.info("=" * 60)
    
    server = HTTPServer(('', PORT), BotHTTPServer)
    logger.info(f"‚úÖ HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
    
    if RENDER_EXTERNAL_URL:
        logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ Telegram: {RENDER_EXTERNAL_URL}/webhook")
    
    logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –í—Å–µ —Ç—Ä–∏ –æ–±—ä–µ–º–∞ –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
    
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        logger.info("‚èπÔ∏è –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()
