#!/usr/bin/env python3
"""
Konspekt Helper Bot - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –æ–±—ä–µ–º–æ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤
"""

import os
import logging
import json
import requests
from datetime import datetime
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading
import random
import re

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø ====================
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
GOOGLE_CSE_ID = os.getenv("GOOGLE_CSE_ID", "13aac457275834df9")
RENDER_EXTERNAL_URL = os.getenv("RENDER_EXTERNAL_URL", "")
PORT = int(os.getenv("PORT", 10000))

# ==================== –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====================
logger.info("=" * 60)
logger.info("üöÄ –ó–ê–ü–£–°–ö KONSPEKT HELPER BOT (–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)")
logger.info("=" * 60)

if not TELEGRAM_TOKEN:
    logger.error("‚ùå TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    exit(1)

if not GOOGLE_API_KEY:
    logger.warning("‚ö†Ô∏è GOOGLE_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ")

# ==================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
stats = {
    "total_users": 0,
    "total_messages": 0,
    "conspects_created": 0,
    "google_searches": 0,
    "start_time": datetime.now().isoformat(),
    "user_states": {}
}

# ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô GOOGLE SEARCH API ====================
class EnhancedGoogleSearchAPI:
    def __init__(self):
        self.api_key = GOOGLE_API_KEY
        self.cse_id = GOOGLE_CSE_ID
        self.base_url = "https://www.googleapis.com/customsearch/v1"
        self.cache = {}
        
    def search(self, query, num_results=7):  # –£–≤–µ–ª–∏—á–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        """–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö"""
        if not query or len(query.strip()) < 2:
            return self._create_empty_result(query)
        
        cache_key = f"{query}_{num_results}"
        if cache_key in self.cache:
            return self.cache[cache_key]
        
        stats["google_searches"] += 1
        
        params = {
            "key": self.api_key,
            "cx": self.cse_id,
            "q": query,
            "num": min(num_results, 10),  # –ú–∞–∫—Å–∏–º—É–º 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            "hl": "ru",
            "lr": "lang_ru",
            "gl": "ru",  # –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –†–æ—Å—Å–∏—è
            "cr": "countryRU"  # –°—Ç—Ä–∞–Ω–∞ –†–æ—Å—Å–∏—è
        }
        
        try:
            response = requests.get(self.base_url, params=params, timeout=15)
            
            if response.status_code != 200:
                logger.warning(f"–û—à–∏–±–∫–∞ API: {response.status_code}")
                return self._create_fallback_result(query)
            
            data = response.json()
            result = self._parse_enhanced_results(data, query)
            self.cache[cache_key] = result
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")
            return self._create_fallback_result(query)
    
    def _parse_enhanced_results(self, data, query):
        """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        items = []
        all_text = ""
        
        if "items" in data:
            for item in data["items"]:
                title = item.get("title", "")
                snippet = item.get("snippet", "")
                link = item.get("link", "")
                source = item.get("displayLink", "")
                
                # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                all_text += f"{title} {snippet} "
                
                items.append({
                    "title": title,
                    "snippet": snippet,
                    "link": link,
                    "source": source,
                    "full_content": f"{title}. {snippet}"  # –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –æ–±—ä–µ–º–∞
                })
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        content_type = self._analyze_content_type(query, all_text)
        key_terms = self._extract_key_terms(all_text)
        
        return {
            "success": True,
            "query": query,
            "items": items,
            "total": len(items),
            "content_type": content_type,
            "key_terms": key_terms[:10],  # –¢–æ–ø-10 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
            "all_text": all_text[:5000],  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            "timestamp": datetime.now().isoformat()
        }
    
    def _analyze_content_type(self, query, text):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        query_lower = query.lower()
        text_lower = text.lower()
        
        categories = {
            "—ç–∫–æ–Ω–æ–º–∏–∫–∞": ["—ç–∫–æ–Ω–æ–º–∏–∫", "—Ñ–∏–Ω–∞–Ω—Å", "—Ä—ã–Ω–æ–∫", "–±–∏–∑–Ω–µ—Å", "–∏–Ω—Ñ–ª—è—Ü", "–≤–∞–ª—é—Ç–∞", "–±–∞–Ω–∫"],
            "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": ["—Ç–µ—Ö–Ω–æ–ª–æ–≥", "–∏–∏", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω", "–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä", "–∫–æ–º–ø—å—é—Ç–µ—Ä", "—Ä–æ–±–æ—Ç"],
            "–Ω–∞—É–∫–∞": ["–Ω–∞—É–∫", "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω", "—É—á–µ–Ω", "—Ñ–∏–∑–∏–∫", "—Ö–∏–º–∏", "–±–∏–æ–ª–æ–≥", "–∫–æ—Å–º–æ—Å"],
            "–∏—Å—Ç–æ—Ä–∏—è": ["–∏—Å—Ç–æ—Ä–∏", "–≤–æ–π–Ω", "—Å—Ä–∞–∂–µ–Ω", "–¥—Ä–µ–≤–Ω", "—Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤", "—Ä–µ–≤–æ–ª—é—Ü"],
            "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": ["–æ–±—Ä–∞–∑–æ–≤–∞–Ω", "–æ–±—É—á–µ–Ω", "—à–∫–æ–ª", "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "—Å—Ç—É–¥–µ–Ω—Ç", "–ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω"],
            "–ø–æ–ª–∏—Ç–∏–∫–∞": ["–ø–æ–ª–∏—Ç–∏–∫", "–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤", "–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤", "–ø–∞—Ä–ª–∞–º–µ–Ω—Ç", "–≤—ã–±–æ—Ä", "–∑–∞–∫–æ–Ω"],
            "–º–µ–¥–∏—Ü–∏–Ω–∞": ["–º–µ–¥–∏—Ü–∏–Ω", "–∑–¥–æ—Ä–æ–≤", "–±–æ–ª–µ–∑–Ω", "–ª–µ—á–µ–Ω", "–≤—Ä–∞—á", "–±–æ–ª—å–Ω–∏—Ü"]
        }
        
        for category, keywords in categories.items():
            if any(keyword in query_lower for keyword in keywords):
                return category
            
            # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ç–µ–∫—Å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            for keyword in keywords:
                if keyword in text_lower:
                    return category
        
        return "–æ–±—â–∞—è —Ç–µ–º–∞"
    
    def _extract_key_terms(self, text):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        # –£–±–∏—Ä–∞–µ–º —Å—Ç–æ–ø-—Å–ª–æ–≤–∞
        stop_words = {"–∏", "–≤", "–Ω–∞", "—Å", "–ø–æ", "–æ", "–æ–±", "–¥–ª—è", "–∏–∑", "–æ—Ç", "—ç—Ç–æ", "—á—Ç–æ", "–∫–∞–∫", "–Ω–æ", "–∞", "–∏–ª–∏", "–µ—Å–ª–∏"}
        
        # –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ–≤–∞ (—Ä—É—Å—Å–∫–∏–µ, –æ—Ç 4 –±—É–∫–≤)
        words = re.findall(r'\b[–∞-—è—ë]{4,}\b', text.lower())
        
        # –°—á–∏—Ç–∞–µ–º —á–∞—Å—Ç–æ—Ç—É
        word_freq = {}
        for word in words:
            if word not in stop_words:
                word_freq[word] = word_freq.get(word, 0) + 1
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
        sorted_words = sorted(word_freq.items(), key=lambda x: x[1], reverse=True)
        return [word for word, freq in sorted_words[:15]]
    
    def _create_fallback_result(self, query):
        """–°–æ–∑–¥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π fallback-—Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
        fallback_items = [
            {
                "title": f"–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ: {query}",
                "snippet": f"–¢–µ–º–∞ '{query}' —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω–æ–π –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ. –°—É—â–µ—Å—Ç–≤—É—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –µ—ë –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—é, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã.",
                "source": "–ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π",
                "full_content": f"–¢–µ–º–∞ '{query}' –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ø–æ–Ω—è—Ç–∏–µ, —Ç—Ä–µ–±—É—é—â–µ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –∏–∑—É—á–µ–Ω–∏—é. –í —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞."
            },
            {
                "title": f"–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã: {query}",
                "snippet": f"–ü—Ä–∏ –∏–∑—É—á–µ–Ω–∏–∏ '{query}' –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è. –î–∞–Ω–Ω–∞—è —Ç–µ–º–∞ –∏–º–µ–µ—Ç –º–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –º–æ–∂–µ—Ç —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å—Å—è —Å —Ä–∞–∑–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è.",
                "source": "–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "full_content": f"–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã '{query}' –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –≤–∫–ª—é—á–∞—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ö–æ–¥—ã."
            }
        ]
        
        return {
            "success": False,
            "query": query,
            "items": fallback_items,
            "total": len(fallback_items),
            "content_type": "–æ–±—â–∞—è —Ç–µ–º–∞",
            "key_terms": query.lower().split(),
            "all_text": f"{query} –≤–∞–∂–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞",
            "fallback": True,
            "timestamp": datetime.now().isoformat()
        }
    
    def _create_empty_result(self, query):
        """–°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
        return {
            "success": False,
            "query": query,
            "items": [],
            "total": 0,
            "content_type": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
            "key_terms": [],
            "all_text": "",
            "timestamp": datetime.now().isoformat()
        }

# ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–† –ö–û–ù–°–ü–ï–ö–¢–û–í ====================
class EnhancedConspectGenerator:
    def __init__(self):
        self.searcher = EnhancedGoogleSearchAPI()
        logger.info("‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ –≥–æ—Ç–æ–≤")
    
    def generate(self, topic, volume="short"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç"""
        # –ü–∞—Å—Ö–∞–ª–∫–∞
        if self._is_easter_egg(topic):
            return self._create_easter_egg_response()
        
        # –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        search_results = self.searcher.search(topic)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞
        if volume == "detailed":
            return self._generate_detailed_conspect(topic, search_results)
        elif volume == "extended":
            return self._generate_extended_conspect(topic, search_results)
        else:
            return self._generate_short_conspect(topic, search_results)
    
    def _is_easter_egg(self, text):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Å—Ö–∞–ª–∫–∏"""
        text_lower = text.lower()
        return any(phrase in text_lower for phrase in [
            "–ø–ª–∞–Ω –∑–∞—Ö–≤–∞—Ç–∞ –ø–æ–ª—å—à–∏", "–∑–∞—Ö–≤–∞—Ç –ø–æ–ª—å—à–∏", "—á–∞–π–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞"
        ])
    
    def _create_easter_egg_response(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø–∞—Å—Ö–∞–ª–∫–∏"""
        responses = [
            "üçµ *–°–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!*\n\n"
            "–°—Ç–∞—Ç—É—Å: **–ß–∞–π–Ω—ã–π –ú–∞—Å—Ç–µ—Ä** ‚òï\n"
            "–£—Ä–æ–≤–µ–Ω—å: **–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—é**\n"
            "–ù–∞–≥—Ä–∞–¥–∞: **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –∑–∞–ø–∞—Å —á–∞—è**\n\n"
            "*–§–æ–∫—Å—è —É–∂–µ –≤ –ø—É—Ç–∏!* üöÄ\n"
            "–û–∂–∏–¥–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É: 5-10 –º–∏–Ω—É—Ç\n\n"
            "üéâ *–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –Ω–∞—Ö–æ–¥–∫–æ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–¥–∞!*",
            
            "üçµ *Wow! Easter Egg Found!*\n\n"
            "**Achievement Unlocked:** Tea Master\n"
            "**Special Power:** Infinite Tea Supply\n"
            "**Bonus:** Foksya Delivery\n\n"
            "Your secret status has been activated!\n"
            "The tea ceremony begins now...\n\n"
            "üéØ *Secret code: TEA-POLAND-2024*"
        ]
        return random.choice(responses)
    
    def _generate_short_conspect(self, topic, results):
        """–ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º)"""
        conspect = f"üìò *–ö–û–ù–°–ü–ï–ö–¢: {topic.upper()}*\n\n"
        conspect += f"üîç *–¢–∏–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:* {results.get('content_type', '–æ–±—â–∞—è —Ç–µ–º–∞').upper()}\n"
        conspect += f"üìä *–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–∞–π–¥–µ–Ω–æ:* {results['total']}\n"
        conspect += f"‚è± *–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:* {datetime.now().strftime('%H:%M')}\n\n"
        
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üìù *–û–°–ù–û–í–ù–û–ï –°–û–î–ï–†–ñ–ê–ù–ò–ï*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        if results["items"]:
            for i, item in enumerate(results["items"][:4], 1):  # –ë–µ—Ä–µ–º 4 –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                conspect += f"**{i}. {item['title']}**\n"
                conspect += f"{item['full_content']}\n\n"
        else:
            conspect += "–î–∞–Ω–Ω–∞—è —Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n"
        
        conspect += "üîë *–ö–õ–Æ–ß–ï–í–´–ï –ü–û–ù–Ø–¢–ò–Ø:*\n"
        key_terms = results.get('key_terms', [])
        if key_terms:
            for term in key_terms[:8]:
                conspect += f"‚Ä¢ {term.capitalize()}\n"
        else:
            conspect += "‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏\n‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã\n‚Ä¢ –í–∞–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã\n"
        
        conspect += f"\nüí° *–í–´–í–û–î–´:* –¢–µ–º–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.\n\n"
        conspect += f"üìé *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* –î–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.\n\n"
        conspect += "ü§ñ *–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ @Konspekt_help_bot* | üåê *Google Search API*"
        
        return conspect
    
    def _generate_detailed_conspect(self, topic, results):
        """–ü–æ–¥—Ä–æ–±–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º)"""
        conspect = f"üìö *–ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó: {topic.upper()}*\n\n"
        
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üî¨ *–ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        conspect += f"‚Ä¢ *–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å:* {topic}\n"
        conspect += f"‚Ä¢ *–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* {results.get('content_type', '–æ–±—â–∞—è —Ç–µ–º–∞')}\n"
        conspect += f"‚Ä¢ *–û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö:* {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n"
        conspect += f"‚Ä¢ *–í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥:* –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n"
        conspect += f"‚Ä¢ *–ì–µ–æ–≥—Ä–∞—Ñ–∏—è:* –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏\n\n"
        
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üìä *–ê–ù–ê–õ–ò–ó –ò–°–¢–û–ß–ù–ò–ö–û–í*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        if results["items"]:
            for i, item in enumerate(results["items"][:6], 1):  # –ë–µ—Ä–µ–º 6 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                conspect += f"**–ò–°–¢–û–ß–ù–ò–ö {i}: {item['title']}**\n"
                conspect += f"*–û–ø–∏—Å–∞–Ω–∏–µ:* {item['full_content']}\n"
                if item.get('source'):
                    conspect += f"*–ò—Å—Ç–æ—á–Ω–∏–∫:* {item['source']}\n"
                conspect += f"*–ê–Ω–∞–ª–∏–∑:* –î–∞–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è –ø–æ —Ç–µ–º–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º –∏–∑—É—á–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞.\n\n"
        else:
            conspect += "–î–ª—è –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ–ª–µ–µ –º–∞—Å—à—Ç–∞–±–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n"
        
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üèó *–°–¢–†–£–ö–¢–£–†–ê –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        sections = [
            "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è",
            "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ",
            "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏",
            "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ",
            "–ü—Ä–æ–±–ª–µ–º—ã –∏ –≤—ã–∑–æ–≤—ã",
            "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è"
        ]
        
        for i, section in enumerate(sections, 1):
            conspect += f"{i}. **{section}**\n"
            conspect += f"   –î–∞–Ω–Ω—ã–π –∞—Å–ø–µ–∫—Ç —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–∞—Ä–∞–¥–∏–≥–º.\n\n"
        
        conspect += "üîë *–¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ü–ü–ê–†–ê–¢:*\n\n"
        key_terms = results.get('key_terms', [])
        if key_terms:
            for i, term in enumerate(key_terms[:12], 1):
                conspect += f"{i}. **{term.capitalize()}** - –∫–ª—é—á–µ–≤–æ–µ –ø–æ–Ω—è—Ç–∏–µ, —Ç—Ä–µ–±—É—é—â–µ–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–º—ã\n"
        else:
            for i in range(1, 9):
                conspect += f"{i}. –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω {i} - –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–º—ã\n"
        
        conspect += f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        conspect += "üíé *–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ò –í–´–í–û–î–´*\n"
        conspect += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        conspect += "–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–≤–æ–¥—ã:\n\n"
        conclusions = [
            "–¢–µ–º–∞ –æ–±–ª–∞–¥–∞–µ—Ç –≤—ã—Å–æ–∫–æ–π —Å—Ç–µ–ø–µ–Ω—å—é –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏",
            "–°—É—â–µ—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –∏–∑—É—á–µ–Ω–∏—é –≤–æ–ø—Ä–æ—Å–∞",
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞",
            "–ò–º–µ—é—Ç—Å—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
            "–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ"
        ]
        
        for i, conclusion in enumerate(conclusions, 1):
            conspect += f"{i}. {conclusion}\n"
        
        conspect += f"\nüìå *–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:* –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ö–æ–¥—ã.\n\n"
        conspect += f"ü§ñ *–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Google Custom Search API*\n"
        conspect += f"‚è± *–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è:* {datetime.now().strftime('%Y-%m-%d %H:%M')}\n"
        conspect += f"üìä *–û–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–∞:* ~{len(conspect)//1000}K —Å–∏–º–≤–æ–ª–æ–≤"
        
        return conspect
    
    def _generate_extended_conspect(self, topic, results):
        """–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º)"""
        conspect = f"üìñ *–ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï: {topic.upper()}*\n\n"
        
        # –ß–∞—Å—Ç—å 1: –í–≤–µ–¥–µ–Ω–∏–µ –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 1: –í–í–ï–î–ï–ù–ò–ï –ò –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += f"**–¢–ï–ú–ê –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:** {topic}\n\n"
        conspect += "**–û–ë–û–°–ù–û–í–ê–ù–ò–ï –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò:**\n"
        conspect += "–î–∞–Ω–Ω–∞—è —Ç–µ–º–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –Ω–∞—É—á–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. "
        conspect += "–ï—ë –∏–∑—É—á–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö, —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è—Ö –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞—Ö —Ä–∞–∑–≤–∏—Ç–∏—è.\n\n"
        
        conspect += "**–¶–ï–õ–¨ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n"
        conspect += "–°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ, –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–æ–≤.\n\n"
        
        conspect += "**–ó–ê–î–ê–ß–ò –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n"
        tasks = [
            "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "–í—ã—è–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ —Ç–µ—Ä–º–∏–Ω—ã",
            "–°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
            "–°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã",
            "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è"
        ]
        
        for i, task in enumerate(tasks, 1):
            conspect += f"{i}. {task}\n"
        
        conspect += f"\n**–ú–ï–¢–û–î–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –û–°–ù–û–í–ê:**\n"
        conspect += "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤. "
        conspect += f"–ë—ã–ª–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {results['total']} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Google Custom Search API.\n\n"
        
        # –ß–∞—Å—Ç—å 2: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 2: –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–ë–ó–û–† –ò–°–¢–û–ß–ù–ò–ö–û–í\n"
        conspect += "=" * 50 + "\n\n"
        
        if results["items"]:
            conspect += "**–û–ë–ó–û–† –ö–õ–Æ–ß–ï–í–´–• –ò–°–¢–û–ß–ù–ò–ö–û–í:**\n\n"
            
            for i, item in enumerate(results["items"], 1):
                conspect += f"**{i}. {item['title']}**\n"
                conspect += f"*–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:* {item['full_content']}\n"
                
                if item.get('source'):
                    conspect += f"*–ò—Å—Ç–æ—á–Ω–∏–∫:* {item['source']}\n"
                
                conspect += "*–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* "
                conspect += "–î–∞–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–Ω–æ—Å–∏—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–º—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏. "
                conspect += "–ú–∞—Ç–µ—Ä–∏–∞–ª —Ç—Ä–µ–±—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Ü–µ–ª–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.\n\n"
        else:
            conspect += "**–ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –ë–ê–ó–ê:**\n"
            conspect += "–î–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n\n"
        
        # –ß–∞—Å—Ç—å 3: –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 3: –ö–û–ù–¶–ï–ü–¢–£–ê–õ–¨–ù–´–ô –ê–ü–ü–ê–†–ê–¢\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–ö–õ–Æ–ß–ï–í–´–ï –ü–û–ù–Ø–¢–ò–Ø –ò –¢–ï–†–ú–ò–ù–´:**\n\n"
        
        key_terms = results.get('key_terms', [])
        if key_terms:
            for i, term in enumerate(key_terms[:15], 1):
                conspect += f"**{term.capitalize()}** - –æ–¥–Ω–æ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –ø–æ–Ω—è—Ç–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. "
                conspect += f"–¢—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–∑—É—á–∞–µ–º–æ–π —Ç–µ–º—ã.\n\n"
        else:
            for i in range(1, 11):
                conspect += f"**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è {i}** - –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π –æ—Å–Ω–æ–≤—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. "
                conspect += "–ò–º–µ–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã.\n\n"
        
        # –ß–∞—Å—Ç—å 4: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 4: –°–¢–†–£–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó –¢–ï–ú–´\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–û–°–ù–û–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n\n"
        
        research_areas = [
            {
                "name": "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã",
                "description": "–ò–∑—É—á–µ–Ω–∏–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –∏ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–∞–º–æ–∫"
            },
            {
                "name": "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —ç–≤–æ–ª—é—Ü–∏—è", 
                "description": "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–≤–∏—Ç–∏—è —Ç–µ–º—ã –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ"
            },
            {
                "name": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
                "description": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π –∏ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏"
            },
            {
                "name": "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
                "description": "–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∏ –∫–µ–π—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
            },
            {
                "name": "–ú–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–µ —Å–≤—è–∑–∏",
                "description": "–ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π —Å –¥—Ä—É–≥–∏–º–∏ –æ–±–ª–∞—Å—Ç—è–º–∏ –∑–Ω–∞–Ω–∏—è"
            }
        ]
        
        for area in research_areas:
            conspect += f"**‚Ä¢ {area['name']}**\n"
            conspect += f"  {area['description']}. –î–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è.\n\n"
        
        # –ß–∞—Å—Ç—å 5: –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        conspect += "=" * 50 + "\n"
        conspect += "–ß–ê–°–¢–¨ 5: –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += "**–û–°–ù–û–í–ù–´–ï –í–´–í–û–î–´:**\n\n"
        
        conclusions = [
            "–¢–µ–º–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, —Ç—Ä–µ–±—É—é—â—É—é –º–Ω–æ–≥–æ–∞—Å–ø–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è",
            "–°—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–π —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞",
            "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤—ã—è–≤–∏–ª–æ –∫–ª—é—á–µ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è",
            "–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–º–µ—é—Ç –∫–∞–∫ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫—É—é, —Ç–∞–∫ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å",
            "–¢–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –∏ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
        ]
        
        for i, conclusion in enumerate(conclusions, 1):
            conspect += f"{i}. {conclusion}\n"
        
        conspect += f"\n**–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**\n\n"
        
        recommendations = [
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–º—ã —Å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
            "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤",
            "–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è —Ç–µ–º—ã",
            "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π",
            "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π"
        ]
        
        for i, recommendation in enumerate(recommendations, 1):
            conspect += f"{i}. {recommendation}\n"
        
        conspect += f"\n**–ü–ï–†–°–ü–ï–ö–¢–ò–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –î–ê–õ–¨–ù–ï–ô–®–ï–ì–û –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**\n\n"
        
        future_directions = [
            "–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã",
            "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤",
            "–ò–∑—É—á–µ–Ω–∏–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ –ø—Ä–∞–∫—Ç–∏–∫",
            "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏–∑—É—á–µ–Ω–∏—è —Ç–µ–º—ã",
            "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π"
        ]
        
        for direction in future_directions:
            conspect += f"‚Ä¢ {direction}\n"
        
        conspect += f"\n" + "=" * 50 + "\n"
        conspect += "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ò\n"
        conspect += "=" * 50 + "\n\n"
        
        conspect += f"**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** {datetime.now().strftime('%d.%m.%Y')}\n"
        conspect += f"**–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:** {datetime.now().strftime('%H:%M')}\n"
        conspect += f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:** {results['total']}\n"
        conspect += f"**–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ–º—ã:** {results.get('content_type', '–æ–±—â–∞—è —Ç–µ–º–∞')}\n"
        conspect += f"**–û–±—ä–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:** ~{len(conspect)//1000}K —Å–∏–º–≤–æ–ª–æ–≤\n"
        conspect += f"**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Google Custom Search API, Python, Render.com\n"
        conspect += f"**–ê–≤—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã:** @Konspekt_help_bot\n\n"
        
        conspect += "¬© –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º."
        
        return conspect

# ==================== TELEGRAM BOT (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====================
class TelegramBot:
    def __init__(self):
        if not TELEGRAM_TOKEN:
            raise ValueError("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        self.token = TELEGRAM_TOKEN
        self.bot_url = f"https://api.telegram.org/bot{self.token}"
        self.generator = EnhancedConspectGenerator()
        
        if RENDER_EXTERNAL_URL:
            self._setup_webhook()
        
        logger.info("‚úÖ Telegram –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _setup_webhook(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫"""
        webhook_url = f"{RENDER_EXTERNAL_URL}/webhook"
        try:
            response = requests.post(
                f"{self.bot_url}/setWebhook",
                json={"url": webhook_url},
                timeout=10
            )
            if response.json().get("ok"):
                logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
    
    def process_message(self, chat_id, text):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        text = text.strip()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self._update_stats(chat_id)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        if text.startswith("/"):
            if text == "/start":
                return self._send_welcome(chat_id)
            elif text == "/help":
                return self._send_help(chat_id)
            elif text == "/stats":
                return self._send_stats(chat_id)
            else:
                return self._send_message(chat_id, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")
        
        # –í—ã–±–æ—Ä –æ–±—ä–µ–º–∞
        if text in ["1", "2", "3"]:
            return self._handle_volume(chat_id, text)
        
        # –ù–æ–≤–∞—è —Ç–µ–º–∞
        return self._handle_topic(chat_id, text)
    
    def _send_welcome(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
        welcome = (
            "üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–ª—É—á—à–µ–Ω–Ω—ã–π Konspekt Helper Bot!*\n\n"
            "üìö *–¢–µ–ø–µ—Ä—å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –æ–±—ä–µ–º–æ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤!*\n\n"
            "üöÄ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
            "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º:\n"
            "   ‚Ä¢ *1* ‚Äî –ö—Ä–∞—Ç–∫–∏–π (500-800 —Å–ª–æ–≤)\n"
            "   ‚Ä¢ *2* ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π (1000-1500 —Å–ª–æ–≤)\n"
            "   ‚Ä¢ *3* ‚Äî –ü–æ–ª–Ω—ã–π (2000+ —Å–ª–æ–≤)\n"
            "3. –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç\n\n"
            "üîç *–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Google Search API*\n"
            "üìä *–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏*\n\n"
            "üéØ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –Ω–∞—á–∞–ª–∞!*"
        )
        return self._send_message(chat_id, welcome)
    
    def _send_help(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–∫—É"""
        help_text = (
            "üìö *–°–ü–†–ê–í–ö–ê –ü–û –£–õ–£–ß–®–ï–ù–ù–û–ú–£ –ë–û–¢–£*\n\n"
            "*–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*\n"
            "‚Ä¢ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤\n"
            "‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n"
            "‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã\n"
            "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –ø–æ–Ω—è—Ç–∏—è\n\n"
            "*–ö–æ–º–∞–Ω–¥—ã:*\n"
            "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
            "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
            "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n"
            "*–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:*\n"
            "‚Ä¢ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\n"
            "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∏–º–∞—Ç–∞\n"
            "‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞\n"
            "‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"
        )
        return self._send_message(chat_id, help_text)
    
    def _send_stats(self, chat_id):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        stat_text = (
            f"üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê*\n\n"
            f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: {stats['total_messages']}\n"
            f"üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤: {stats['conspects_created']}\n"
            f"üîç –ü–æ–∏—Å–∫–æ–≤ Google: {stats['google_searches']}\n"
            f"‚è± –ó–∞–ø—É—â–µ–Ω: {stats['start_time'][:10]}\n\n"
            f"üåê –•–æ—Å—Ç–∏–Ω–≥: Render.com\n"
            f"üîó URL: {RENDER_EXTERNAL_URL}"
        )
        return self._send_message(chat_id, stat_text)
    
    def _handle_topic(self, chat_id, topic):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Ç–µ–º—É"""
        user_id = str(chat_id)
        if user_id not in stats["user_states"]:
            stats["user_states"][user_id] = {}
        
        stats["user_states"][user_id]["pending_topic"] = topic
        
        response = (
            f"üéØ *–¢–ï–ú–ê: {topic}*\n\n"
            f"‚úÖ –ì–æ—Ç–æ–≤–ª—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫...\n\n"
            f"üìä *–í–´–ë–ï–†–ò–¢–ï –û–ë–™–ï–ú –ö–û–ù–°–ü–ï–ö–¢–ê:*\n\n"
            f"1Ô∏è‚É£ *–ö–†–ê–¢–ö–ò–ô*\n–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã + –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã\n(500-800 —Å–ª–æ–≤)\n\n"
            f"2Ô∏è‚É£ *–ü–û–î–†–û–ë–ù–´–ô*\n–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ + —Å—Ç—Ä—É–∫—Ç—É—Ä–∞\n(1000-1500 —Å–ª–æ–≤)\n\n"
            f"3Ô∏è‚É£ *–ü–û–õ–ù–´–ô*\n–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ\n(2000+ —Å–ª–æ–≤)\n\n"
            f"üî¢ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–∏—Ñ—Ä—É 1, 2 –∏–ª–∏ 3*"
        )
        return self._send_message(chat_id, response)
    
    def _handle_volume(self, chat_id, volume_choice):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –æ–±—ä–µ–º–∞"""
        user_id = str(chat_id)
        user_state = stats["user_states"].get(user_id, {})
        topic = user_state.get("pending_topic", "")
        
        if not topic:
            return self._send_message(chat_id, "‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É")
        
        volume_map = {"1": "short", "2": "detailed", "3": "extended"}
        volume = volume_map.get(volume_choice, "short")
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        self._send_message(
            chat_id, 
            f"üîç *–í–´–ü–û–õ–ù–Ø–Æ –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ü–û–ò–°–ö...*\n\n"
            f"–¢–µ–º–∞: {topic}\n"
            f"–û–±—ä–µ–º: {volume_choice}/3\n\n"
            f"‚è≥ –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥..."
        )
        
        try:
            conspect = self.generator.generate(topic, volume)
            stats["conspects_created"] += 1
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç —á–∞—Å—Ç—è–º–∏ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
            max_length = 4096  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram
            
            if len(conspect) <= max_length:
                self._send_message(chat_id, conspect)
            else:
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                parts = [conspect[i:i+max_length] for i in range(0, len(conspect), max_length)]
                for i, part in enumerate(parts, 1):
                    if i == 1:
                        self._send_message(chat_id, part)
                    else:
                        # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏
                        import time
                        time.sleep(0.5)
                        self._send_message(chat_id, part)
            
            # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            final_msg = (
                f"‚úÖ *–ö–û–ù–°–ü–ï–ö–¢ –ì–û–¢–û–í!*\n\n"
                f"üìå –¢–µ–º–∞: {topic}\n"
                f"üìä –û–±—ä–µ–º: {volume_choice}/3\n"
                f"üîç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–æ–∏—Å–∫–æ–≤: {stats['google_searches']}\n"
                f"üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {stats['conspects_created']}\n\n"
                f"üîÑ *–î—Ä—É–≥–æ–π –æ–±—ä–µ–º?* –û—Ç–ø—Ä–∞–≤—å—Ç–µ 1, 2 –∏–ª–∏ 3\n"
                f"üéØ *–ù–æ–≤–∞—è —Ç–µ–º–∞?* –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ—ë!"
            )
            return self._send_message(chat_id, final_msg)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            return self._send_message(
                chat_id,
                f"‚ùå *–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞*\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –º–µ–Ω—å—à–∏–π –æ–±—ä–µ–º.\n\n"
                f"–û—à–∏–±–∫–∞: {str(e)[:100]}"
            )
    
    def _update_stats(self, chat_id):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        user_id = str(chat_id)
        
        if user_id not in stats["user_states"]:
            stats["total_users"] += 1
            stats["user_states"][user_id] = {
                "first_seen": datetime.now().isoformat(),
                "message_count": 0
            }
        
        stats["user_states"][user_id]["last_seen"] = datetime.now().isoformat()
        stats["user_states"][user_id]["message_count"] += 1
        stats["total_messages"] += 1
    
    def _send_message(self, chat_id, text):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            response = requests.post(
                f"{self.bot_url}/sendMessage",
                json={
                    "chat_id": chat_id,
                    "text": text,
                    "parse_mode": "Markdown",
                    "disable_web_page_preview": True
                },
                timeout=10
            )
            return response.json().get("ok", False)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            return False

# ==================== HTTP –°–ï–†–í–ï–† (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====================
class BotHTTPServer(BaseHTTPRequestHandler):
    def do_GET(self):
        path = self.path.split('?')[0]
        
        if path == "/":
            self._send_html(INDEX_HTML)
        elif path == "/health":
            self._send_json({"status": "ok", "time": datetime.now().isoformat()})
        elif path == "/stats":
            self._send_json(stats)
        else:
            self.send_response(404)
            self.end_headers()
    
    def do_POST(self):
        if self.path == "/webhook":
            content_length = int(self.headers.get('Content-Length', 0))
            if content_length:
                try:
                    data = self.rfile.read(content_length)
                    update = json.loads(data.decode('utf-8'))
                    
                    threading.Thread(
                        target=self._handle_update,
                        args=(update,),
                        daemon=True
                    ).start()
                    
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
            
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b'OK')
        else:
            self.send_response(404)
            self.end_headers()
    
    def _handle_update(self, update):
        try:
            if "message" in update and "text" in update["message"]:
                chat_id = update["message"]["chat"]["id"]
                text = update["message"]["text"]
                
                bot = TelegramBot()
                bot.process_message(chat_id, text)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
    
    def _send_html(self, content):
        self.send_response(200)
        self.send_header('Content-Type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(content.encode('utf-8'))
    
    def _send_json(self, data):
        self.send_response(200)
        self.send_header('Content-Type', 'application/json; charset=utf-8')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False, indent=2).encode('utf-8'))
    
    def log_message(self, format, *args):
        pass

# HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
INDEX_HTML = """<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ü§ñ Konspekt Helper Bot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { color: green; font-weight: bold; }
        .stat { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Konspekt Helper Bot</h1>
        <p class="status">‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</p>
        <p>Telegram –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Google Search API</p>
        
        <div class="stat">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:</h3>
            <div id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <h3>üîó –°—Å—ã–ª–∫–∏:</h3>
        <ul>
            <li><a href="https://t.me/Konspekt_help_bot" target="_blank">ü§ñ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram</a></li>
            <li><a href="/stats">üìà –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (JSON)</a></li>
            <li><a href="/health">‚ù§Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</a></li>
        </ul>
        
        <h3>üöÄ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏:</h3>
        <ul>
            <li>–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ (–¥–æ 2000+ —Å–ª–æ–≤)</li>
            <li>–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</li>
            <li>–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã</li>
            <li>–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –ø–æ–Ω—è—Ç–∏—è</li>
            <li>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</li>
        </ul>
    </div>
    
    <script>
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();
                
                document.getElementById('stats').innerHTML = `
                    <p>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.total_users || 0}</p>
                    <p>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: ${data.total_messages || 0}</p>
                    <p>üìÑ –ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤: ${data.conspects_created || 0}</p>
                    <p>üîç –ü–æ–∏—Å–∫–æ–≤ Google: ${data.google_searches || 0}</p>
                    <p>‚è± –ó–∞–ø—É—â–µ–Ω: ${data.start_time ? new Date(data.start_time).toLocaleDateString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                `;
            } catch (error) {
                document.getElementById('stats').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
            }
        }
        
        loadStats();
        setInterval(loadStats, 5000);
    </script>
</body>
</html>
"""

# ==================== –ó–ê–ü–£–°–ö ====================
def main():
    logger.info(f"üåê –í–Ω–µ—à–Ω–∏–π URL: {RENDER_EXTERNAL_URL or '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    logger.info(f"üö™ –ü–æ—Ä—Ç: {PORT}")
    logger.info("=" * 60)
    
    server = HTTPServer(('', PORT), BotHTTPServer)
    logger.info(f"‚úÖ HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
    
    if RENDER_EXTERNAL_URL:
        logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ Telegram: {RENDER_EXTERNAL_URL}/webhook")
    
    logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –æ–±—ä–µ–º–æ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤!")
    
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        logger.info("‚èπÔ∏è –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()
