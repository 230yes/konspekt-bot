#!/usr/bin/env python3
"""
Konspekt Helper Bot - Telegram –±–æ—Ç —Å AI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤
–ë–æ—Ç: @Konspekt_help_bot
–í–µ—Ä—Å–∏—è: Python 3.11.8
"""

import logging
import json
import os
import re
import random
from datetime import datetime
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse
import threading
import time

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# HTML —à–∞–±–ª–æ–Ω –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞
HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Konspekt_help_bot - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }}
        header {{
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 30px;
            text-align: center;
        }}
        h1 {{
            font-size: 2.5em;
            margin-bottom: 10px;
        }}
        .content {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 30px;
        }}
        .card {{
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }}
        .card h2 {{
            color: #4A00E0;
            margin-bottom: 15px;
            border-bottom: 2px solid #4A00E0;
            padding-bottom: 10px;
        }}
        .stat-grid {{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }}
        .stat-item {{
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4A00E0;
        }}
        .stat-value {{
            font-size: 1.8em;
            font-weight: bold;
            color: #4A00E0;
        }}
        .btn {{
            display: inline-block;
            background: #4A00E0;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            text-decoration: none;
            margin: 10px 5px;
            font-weight: bold;
        }}
        footer {{
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
        }}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö @Konspekt_help_bot</h1>
            <p>AI-–±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</p>
        </header>
        
        <div class="content">
            <div class="card">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div>–°–æ–æ–±—â–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="conspectsCreated">0</div>
                        <div>–ö–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeToday">0</div>
                        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <a href="/stats.json" class="btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (JSON)</a>
                    <a href="/health" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ</a>
                </div>
            </div>
            
            <div class="card">
                <h2>ü§ñ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞</h2>
                <p><strong>–ë–æ—Ç —É–º–µ–µ—Ç:</strong></p>
                <ul>
                    <li>–°–æ–∑–¥–∞–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å–ø–µ–∫—Ç—ã —Å –ø–æ–º–æ—â—å—é AI</li>
                    <li>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Ç–µ–º—ã</li>
                    <li>–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</li>
                    <li>–ò—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ</li>
                </ul>
                <div style="margin-top: 20px;">
                    <a href="https://t.me/Konspekt_help_bot" class="btn" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
                </div>
            </div>
            
            <div class="card">
                <h2>üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h2>
                <p>1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–≤–æ–π–Ω–∞ –∏ –æ–±—â–µ—Å—Ç–≤–æ")</p>
                <p>2. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º: 1, 2 –∏–ª–∏ 3</p>
                <p>3. –ü–æ–ª—É—á–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π AI-–∫–æ–Ω—Å–ø–µ–∫—Ç</p>
                <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    * –í –±–æ—Ç–µ –µ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ –¥–ª—è —Å–∞–º—ã—Ö –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã—Ö
                </p>
            </div>
        </div>
        
        <footer>
            <p>¬© 2024 @Konspekt_help_bot | AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ | Render.com</p>
        </footer>
    </div>
    
    <script>
        async function loadStats() {{
            try {{
                const response = await fetch('/stats.json');
                const data = await response.json();
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('totalMessages').textContent = data.stats.total_messages;
                document.getElementById('conspectsCreated').textContent = data.stats.conspects_created;
                document.getElementById('activeToday').textContent = data.stats.active_today;
            }} catch (error) {{
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }}
        }}
        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>
"""

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
stats = {
    "total_users": 0,
    "total_messages": 0,
    "active_today": 0,
    "conspects_created": 0,
    "start_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "user_activity": {},
    "user_states": {}
}

class AIConspectGenerator:
    """AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Å –≤–µ–±-–ø–æ–∏—Å–∫–æ–º"""
    
    @staticmethod
    def is_easter_egg(text):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞—Å—Ö–∞–ª–∫—É"""
        text_lower = text.lower()
        easter_egg_phrases = [
            "–ø–ª–∞–Ω –∑–∞—Ö–≤–∞—Ç–∞ –ø–æ–ª—å—à–∏",
            "–∑–∞—Ö–≤–∞—Ç –ø–æ–ª—å—à–∏",
            "–ø–ª–∞–Ω –ø–æ –∑–∞—Ö–≤–∞—Ç—É –ø–æ–ª—å—à–∏", 
            "–∫–∞–∫ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –ø–æ–ª—å—à—É",
            "—Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞—Ö–≤–∞—Ç–∞ –ø–æ–ª—å—à–∏",
            "–≤—Ç–æ—Ä–∂–µ–Ω–∏–µ –≤ –ø–æ–ª—å—à—É",
            "–æ–∫–∫—É–ø–∞—Ü–∏—è –ø–æ–ª—å—à–∏",
            "–∑–∞–≤–æ–µ–≤–∞–Ω–∏–µ –ø–æ–ª—å—à–∏",
            "–∑–∞—Ö–≤–∞—Ç –ø–æ–ª—å—à–∏ –ø–ª–∞–Ω",
            "–ø–æ–ª—å—à–∞ –∑–∞—Ö–≤–∞—Ç",
            "–∑–∞—Ö–≤–∞—Ç–∏—Ç—å –ø–æ–ª—å—à—É",
            "–ø–æ–ª—å—à–∞ –ø–ª–∞–Ω –∑–∞—Ö–≤–∞—Ç–∞",
            "–ø–ª–∞–Ω –≤—Ç–æ—Ä–∂–µ–Ω–∏—è –≤ –ø–æ–ª—å—à—É",
            "–≤–æ–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å—à–∞",
            "–∞—Ç–∞–∫–∞ –Ω–∞ –ø–æ–ª—å—à—É"
        ]
        
        for phrase in easter_egg_phrases:
            if phrase in text_lower:
                return True
        return False
    
    @staticmethod
    def generate_easter_egg():
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Å—Ö–∞–ª–∫–∏"""
        responses = [
            "üçµ *–ü–æ–∑–¥—Ä–∞–≤–ª—è—é –≤—ã —Å—Ç–∞–ª–∏ –ß–∞–µ–º —Å–∫–æ—Ä–æ –ø—Ä–∏–¥–µ—Ç —Ñ–æ–∫—Å—è*",
            "üçµ *–°—Ç–∞—Ç—É—Å: –ß–∞–π. –§–æ–∫—Å—è –≤ –ø—É—Ç–∏.*",
            "üçµ *–í—ã - –ß–∞–π. –§–æ–∫—Å—è –±–ª–∏–∑–∫–æ.*",
            "üçµ *–ß–∞–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –§–æ–∫—Å—è —Å–∫–æ—Ä–æ.*"
        ]
        return random.choice(responses)
    
    @staticmethod
    def simulate_web_search(topic):
        """–ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–æ–≤ API –ø–æ–∏—Å–∫–∞
        # –ù–æ –¥–ª—è –¥–µ–º–æ —Å–æ–∑–¥–∞–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∏–º–∏—Ç–∞—Ü–∏—é
        
        search_keywords = topic.lower().split()
        main_keyword = search_keywords[0] if search_keywords else topic
        
        # –°–æ–∑–¥–∞–µ–º "–Ω–∞–π–¥–µ–Ω–Ω—É—é" –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
        found_info = {
            "sources": [
                f"–í–∏–∫–∏–ø–µ–¥–∏—è: {topic}",
                f"–ù–∞—É—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ {main_keyword}",
                f"–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
                f"–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –º–Ω–µ–Ω–∏—è"
            ],
            "key_points": [],
            "examples": [],
            "statistics": f"–ù–∞–π–¥–µ–Ω–æ {random.randint(50, 200)} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ —Ç–µ–º–µ"
        }
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
        if "–≤–æ–π–Ω–∞" in topic.lower():
            found_info["key_points"] = [
                "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏",
                "–í–æ–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Ç–∞–∫—Ç–∏–∫–∏",
                "–°–æ—Ü–∏–∞–ª—å–Ω–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
                "–í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
                "–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –∂–µ—Ä—Ç–≤—ã"
            ]
            found_info["examples"] = [
                "–ü–µ—Ä–≤–∞—è –∏ –í—Ç–æ—Ä–∞—è –º–∏—Ä–æ–≤—ã–µ –≤–æ–π–Ω—ã",
                "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã",
                "–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–π–Ω–∞ –∏ –µ—ë –Ω–∞—Å–ª–µ–¥–∏–µ"
            ]
        elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic.lower():
            found_info["key_points"] = [
                "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä–∞—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è",
                "–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –Ω–æ—Ä–º—ã –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏",
                "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã",
                "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã",
                "–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"
            ]
        elif "—Ç–µ—Ö–Ω–æ–ª–æ–≥" in topic.lower():
            found_info["key_points"] = [
                "–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π",
                "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏",
                "–í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∫—É",
                "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
                "–≠—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã"
            ]
        else:
            # –û–±—â–∏–π —Å–ª—É—á–∞–π
            found_info["key_points"] = [
                f"–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã {main_keyword}",
                f"–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ {main_keyword}",
                f"–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ",
                f"–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏",
                f"–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –Ω–∞ –±—É–¥—É—â–µ–µ"
            ]
        
        return found_info
    
    @staticmethod
    def generate_ai_conspect(topic, volume, search_results=None):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ —Å –ø–æ–º–æ—â—å—é AI –ª–æ–≥–∏–∫–∏"""
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        topic_lower = topic.lower()
        
        # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if volume == "–∫—Ä–∞—Ç–∫–∏–π":
            return AIConspectGenerator._generate_short_ai(topic, topic_lower, search_results)
        elif volume == "–ø–æ–¥—Ä–æ–±–Ω—ã–π":
            return AIConspectGenerator._generate_detailed_ai(topic, topic_lower, search_results)
        else:  # —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π
            return AIConspectGenerator._generate_extended_ai(topic, topic_lower, search_results)
    
    @staticmethod
    def _generate_short_ai(topic, topic_lower, search_results):
        """–ö—Ä–∞—Ç–∫–∏–π AI-–∫–æ–Ω—Å–ø–µ–∫—Ç"""
        
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
        conspect_parts = []
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        conspect_parts.append(f"üìÑ *–ö–û–ù–°–ü–ï–ö–¢: {topic.upper()}*\n\n")
        
        # –í–≤–µ–¥–µ–Ω–∏–µ
        intro_phrases = [
            f"–¢–µ–º–∞ '{topic}' –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –≤–∞–∂–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, ",
            f"–ò–∑—É—á–µ–Ω–∏–µ '{topic}' –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–Ω—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã ",
            f"–ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã '{topic}' —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã ",
            f"–ö–æ–Ω—Ü–µ–ø—Ü–∏—è '{topic}' —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è "
        ]
        
        conspect_parts.append(f"üéØ *–í–í–ï–î–ï–ù–ò–ï:*\n")
        conspect_parts.append(random.choice(intro_phrases))
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ–º—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if "–≤–æ–π–Ω–∞" in topic_lower:
            conspect_parts.append("–≤–æ–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –∏—Ö –≤–ª–∏—è–Ω–∏—è –Ω–∞ –º–∏—Ä–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å.\n\n")
        elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic_lower:
            conspect_parts.append("—Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ.\n\n")
        elif "—Ç–µ—Ö–Ω–æ–ª–æ–≥" in topic_lower:
            conspect_parts.append("—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –µ–≥–æ —Ä–æ–ª–∏ –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏.\n\n")
        elif any(word in topic_lower for word in ["–Ω–∞—É–∫", "—Ñ–∏–∑–∏–∫", "—Ö–∏–º–∏", "–±–∏–æ–ª–æ–≥"]):
            conspect_parts.append("–Ω–∞—É—á–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π –∏ –∏—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.\n\n")
        elif any(word in topic_lower for word in ["–æ–±—Ä–∞–∑–æ–≤–∞–Ω", "—É—á–µ–±", "—à–∫–æ–ª", "—É–Ω–∏–≤–µ—Ä"]):
            conspect_parts.append("–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –º–µ—Ç–æ–¥–∏–∫ –æ–±—É—á–µ–Ω–∏—è.\n\n")
        else:
            conspect_parts.append("–¥–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –∑–Ω–∞–Ω–∏—è –∏ –µ—ë –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏.\n\n")
        
        # –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
        conspect_parts.append(f"üìå *–û–°–ù–û–í–ù–´–ï –¢–ï–ó–ò–°–´:*\n")
        
        thesis_templates = [
            "1. {} –∏–º–µ–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è\n",
            "2. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ {} —Ç—Ä–µ–±—É–µ—Ç –º–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞\n", 
            "3. {} –æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã\n",
            "4. –ü–æ–Ω–∏–º–∞–Ω–∏–µ {} –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—â–∏—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π\n",
            "5. {} –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫–∞–∫ –¥–ª—è —Ç–µ–æ—Ä–µ—Ç–∏–∫–æ–≤, —Ç–∞–∫ –∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–æ–≤\n"
        ]
        
        keyword = topic.split()[0] if topic.split() else "—Ç–µ–º–∞"
        for i, template in enumerate(thesis_templates[:3]):
            conspect_parts.append(template.format(keyword))
        
        conspect_parts.append(f"\nüîë *–ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´:*\n")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—Å–ø–µ–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
        aspects = []
        if "–≤–æ–π–Ω–∞" in topic_lower:
            aspects = ["–ü—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏", "–•–æ–¥ —Å–æ–±—ã—Ç–∏–π", "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏ –∏—Ç–æ–≥–∏", "–£—Ä–æ–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏"]
        elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic_lower:
            aspects = ["–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –Ω–æ—Ä–º—ã", "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"]
        elif "—Ç–µ—Ö–Ω–æ–ª–æ–≥" in topic_lower:
            aspects = ["–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã", "–û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è", "–í–ª–∏—è–Ω–∏–µ –Ω–∞ –∂–∏–∑–Ω—å", "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è"]
        else:
            aspects = ["–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã", "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ", "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"]
        
        for aspect in aspects[:4]:
            conspect_parts.append(f"‚Ä¢ {aspect}\n")
        
        conspect_parts.append(f"\nüí° *–í–´–í–û–î–´:*\n")
        conspect_parts.append(f"‚Ä¢ –¢–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è\n")
        conspect_parts.append(f"‚Ä¢ –ò–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ñ–µ—Ä\n")
        conspect_parts.append(f"‚Ä¢ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π\n")
        
        return "".join(conspect_parts)
    
    @staticmethod
    def _generate_detailed_ai(topic, topic_lower, search_results):
        """–ü–æ–¥—Ä–æ–±–Ω—ã–π AI-–∫–æ–Ω—Å–ø–µ–∫—Ç"""
        
        conspect_parts = []
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        conspect_parts.append(f"üìö *–†–ê–ó–í–ï–†–ù–£–¢–´–ô –ö–û–ù–°–ü–ï–ö–¢: {topic.upper()}*\n\n")
        
        # –í–≤–µ–¥–µ–Ω–∏–µ —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –∞–Ω–∞–ª–∏–∑–∞
        conspect_parts.append(f"üéØ *–ê–ù–ê–õ–ò–ó –¢–ï–ú–´:*\n")
        conspect_parts.append(f"–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π, —Ç–µ–º–∞ '{topic}' "
                             f"—Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö "
                             f"–≤–Ω–æ—Å–∏—Ç –≤–∫–ª–∞–¥ –≤ –æ–±—â–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞.\n\n")
        
        # –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
        sections = [
            ("–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –ö–û–ù–¢–ï–ö–°–¢", 
             ["–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏", "–≠–≤–æ–ª—é—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π", "–ö–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã —Ä–∞–∑–≤–∏—Ç–∏—è"]),
            
            ("–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò–ï –û–°–ù–û–í–ê–ù–ò–Ø",
             ["–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ö–æ–¥—ã", "–ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç", "–ù–∞—É—á–Ω—ã–µ –ø–∞—Ä–∞–¥–∏–≥–º—ã"]),
            
            ("–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ê–°–ü–ï–ö–¢–´",
             ["–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ñ–µ—Ä–∞—Ö", "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã", "–ü—Ä–∏–∫–ª–∞–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"]),
            
            ("–°–û–í–†–ï–ú–ï–ù–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï",
             ["–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã", "–¢–µ–∫—É—â–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏"]),
            
            ("–ü–ï–†–°–ü–ï–ö–¢–ò–í–´ –†–ê–ó–í–ò–¢–ò–Ø",
             ["–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π", "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è", "–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ –±—É–¥—É—â–µ–µ"])
        ]
        
        for i, (title, points) in enumerate(sections, 1):
            conspect_parts.append(f"{i}. *{title}*\n")
            
            # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–¥ —Ç–µ–º—É
            adapted_points = []
            for point in points:
                if "–≤–æ–π–Ω–∞" in topic_lower:
                    if "–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô" in title:
                        adapted_points.append(f"   ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏\n")
                    elif "–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –¢–µ–æ—Ä–∏–∏ –≤–æ–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n")
                    elif "–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –†–µ–∞–ª—å–Ω—ã–µ –≤–æ–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑\n")
                    elif "–°–û–í–†–ï–ú–ï–ù–ù–û–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–æ–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –¥–æ–∫—Ç—Ä–∏–Ω—ã\n")
                    elif "–ü–ï–†–°–ü–ï–ö–¢–ò–í–´" in title:
                        adapted_points.append(f"   ‚Ä¢ –ë—É–¥—É—â–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ –≤–æ–µ–Ω–Ω–æ–º –¥–µ–ª–µ\n")
                elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic_lower:
                    if "–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô" in title:
                        adapted_points.append(f"   ‚Ä¢ –≠–≤–æ–ª—é—Ü–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä\n")
                    elif "–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –°–æ—Ü–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ–æ—Ä–∏–∏ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏\n")
                    elif "–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã\n")
                    elif "–°–û–í–†–ï–ú–ï–ù–ù–û–ï" in title:
                        adapted_points.append(f"   ‚Ä¢ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã\n")
                    elif "–ü–ï–†–°–ü–ï–ö–¢–ò–í–´" in title:
                        adapted_points.append(f"   ‚Ä¢ –ë—É–¥—É—â–µ–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è\n")
                else:
                    adapted_points.append(f"   ‚Ä¢ {point} –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–º—ã\n")
            
            conspect_parts.extend(adapted_points[:3])
            conspect_parts.append("\n")
        
        # –ü—Ä–∏–º–µ—Ä—ã –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
        conspect_parts.append(f"üìù *–ü–†–ò–ú–ï–†–´ –ò –ò–õ–õ–Æ–°–¢–†–ê–¶–ò–ò:*\n")
        
        examples = []
        if "–≤–æ–π–Ω–∞" in topic_lower:
            examples = [
                "‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤",
                "‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ä–∞–∑–Ω—ã—Ö —ç–ø–æ—Ö", 
                "‚Ä¢ –ò–∑—É—á–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –≤–æ–π–Ω –Ω–∞ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            ]
        elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic_lower:
            examples = [
                "‚Ä¢ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤",
                "‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫",
                "‚Ä¢ –ò–∑—É—á–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –º–æ–±–∏–ª—å–Ω–æ—Å—Ç–∏"
            ]
        elif "—Ç–µ—Ö–Ω–æ–ª–æ–≥" in topic_lower:
            examples = [
                "‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–Ω–Ω–æ–≤–∞—Ü–∏–π",
                "‚Ä¢ –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –Ω–∞ –∂–∏–∑–Ω—å",
                "‚Ä¢ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤"
            ]
        else:
            examples = [
                "‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ",
                "‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è",
                "‚Ä¢ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–¥—Ö–æ–¥–æ–≤"
            ]
        
        conspect_parts.extend(examples)
        conspect_parts.append(f"\n\nüíé *–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ò –í–´–í–û–î–´:*\n")
        
        conclusion_phrases = [
            f"–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã '{topic}' –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥ –æ –µ—ë –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ ",
            f"–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ '{topic}' –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã ",
            f"–ò–∑—É—á–µ–Ω–∏–µ '{topic}' —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≥–ª—É–±–∏–Ω–Ω—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ "
        ]
        
        conspect_parts.append(random.choice(conclusion_phrases))
        conspect_parts.append("–¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—â–∏—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π. ")
        conspect_parts.append("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ñ–µ—Ä–∞—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.\n\n")
        
        conspect_parts.append(f"üîç *–ò–°–¢–û–ß–ù–ò–ö–ò –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:*\n")
        conspect_parts.append(f"‚Ä¢ –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏\n")
        conspect_parts.append(f"‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞\n")
        conspect_parts.append(f"‚Ä¢ –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –º–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n")
        
        return "".join(conspect_parts)
    
    @staticmethod
    def _generate_extended_ai(topic, topic_lower, search_results):
        """–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π AI-–∫–æ–Ω—Å–ø–µ–∫—Ç"""
        
        conspect_parts = []
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –≤–≤–µ–¥–µ–Ω–∏–µ
        conspect_parts.append(f"üìñ *–ü–û–õ–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï: {topic.upper()}*\n\n")
        
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
        conspect_parts.append(f"–ß–ê–°–¢–¨ 1: –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó\n")
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")
        
        # –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å
        conspect_parts.append(f"1.1 *–ú–ï–¢–û–î–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ü–û–î–•–û–î–´ –ö –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Æ*\n")
        
        methodologies = [
            "–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥",
            "–ò—Å—Ç–æ—Ä–∏–∫–æ-–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ –∏–∑—É—á–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è",
            "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π",
            "–ú–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–Ω–∞–Ω–∏–π",
            "–≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è"
        ]
        
        for method in methodologies[:3]:
            conspect_parts.append(f"   ‚Ä¢ {method}\n")
        
        conspect_parts.append(f"\n1.2 *–ö–û–ù–¶–ï–ü–¢–£–ê–õ–¨–ù–´–ô –ê–ü–ü–ê–†–ê–¢ –ò –¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–Ø*\n")
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –ø–æ–¥ —Ç–µ–º—É
        if "–≤–æ–π–Ω–∞" in topic_lower:
            terms = [
                "–í–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è",
                "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ —Ç–∞–∫—Ç–∏–∫–∞ –≤–æ–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π", 
                "–ì–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤",
                "–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ –ø—Ä–∞–≤–æ –∏ —ç—Ç–∏–∫–∞ –≤–æ–π–Ω—ã"
            ]
        elif "–æ–±—â–µ—Å—Ç–≤–æ" in topic_lower:
            terms = [
                "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä–∞—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è",
                "–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –Ω–æ—Ä–º—ã –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã",
                "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –¥–∏–Ω–∞–º–∏–∫–∞",
                "–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"
            ]
        elif "—Ç–µ—Ö–Ω–æ–ª–æ–≥" in topic_lower:
            terms = [
                "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∏ –¥–∏—Ñ—Ñ—É–∑–∏—è",
                "–¶–∏—Ñ—Ä–æ–≤–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤",
                "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä–≥–µ–Ω—Ü–∏—è",
                "–≠—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π"
            ]
        else:
            terms = [
                "–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è",
                "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è",
                "–ö–ª—é—á–µ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–∞",
                "–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã"
            ]
        
        for term in terms:
            conspect_parts.append(f"   ‚Ä¢ {term}\n")
        
        conspect_parts.append(f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
        conspect_parts.append(f"–ß–ê–°–¢–¨ 2: –°–¢–†–£–ö–¢–£–†–ù–´–ô –ò –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó\n")
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")
        
        # –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        conspect_parts.append(f"2.1 *–í–ù–£–¢–†–ï–ù–ù–Ø–Ø –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø –ò –°–¢–†–£–ö–¢–£–†–ê*\n")
        
        structural_aspects = [
            "–ò–µ—Ä–∞—Ä—Ö–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –ø–æ–¥—Å–∏—Å—Ç–µ–º",
            "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤",
            "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –∏–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã",
            "–ê–¥–∞–ø—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Å–∏—Å—Ç–µ–º—ã"
        ]
        
        for aspect in structural_aspects:
            conspect_parts.append(f"   ‚Ä¢ {aspect}\n")
        
        conspect_parts.append(f"\n2.2 *–î–ò–ù–ê–ú–ò–ö–ê –†–ê–ó–í–ò–¢–ò–Ø –ò –≠–í–û–õ–Æ–¶–ò–Ø*\n")
        
        dynamic_aspects = [
            "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è",
            "–§–∞–∫—Ç–æ—Ä—ã –∏ –¥–≤–∏–∂—É—â–∏–µ —Å–∏–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π",
            "–ö—Ä–∏–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "–ü—Ä–µ–µ–º—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏"
        ]
        
        for aspect in dynamic_aspects:
            conspect_parts.append(f"   ‚Ä¢ {aspect}\n")
        
        conspect_parts.append(f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
        conspect_parts.append(f"–ß–ê–°–¢–¨ 3: –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ò –ü–†–ò–ö–õ–ê–î–ù–´–ï –ê–°–ü–ï–ö–¢–´\n")
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")
        
        # –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å
        conspect_parts.append(f"3.1 *–†–ï–ê–õ–¨–ù–´–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –ò –í–ù–ï–î–†–ï–ù–ò–ï*\n")
        
        applications = [
            "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ñ–µ—Ä–∞—Ö",
            "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è",
            "–ë–∞—Ä—å–µ—Ä—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è",
            "–£—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏"
        ]
        
        for app in applications:
            conspect_parts.append(f"   ‚Ä¢ {app}\n")
        
        conspect_parts.append(f"\n3.2 *–°–û–¶–ò–ê–õ–¨–ù–û-–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ï –ü–û–°–õ–ï–î–°–¢–í–ò–Ø*\n")
        
        consequences = [
            "–í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã",
            "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "–ö—É–ª—å—Ç—É—Ä–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è",
            "–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å"
        ]
        
        for consequence in consequences:
            conspect_parts.append(f"   ‚Ä¢ {consequence}\n")
        
        conspect_parts.append(f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
        conspect_parts.append(f"–ß–ê–°–¢–¨ 4: –ü–ï–†–°–ü–ï–ö–¢–ò–í–´ –ò –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ò–ï –í–´–í–û–î–´\n")
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")
        
        # –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∏ –≤—ã–≤–æ–¥—ã
        conspect_parts.append(f"4.1 *–ë–£–î–£–©–ò–ï –¢–ï–ù–î–ï–ù–¶–ò–ò –ò –ü–†–û–ì–ù–û–ó–´*\n")
        
        trends = [
            "–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è",
            "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Ä—ã–≤—ã",
            "–û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–¥—Ö–æ–¥–∞—Ö",
            "–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —ç–≤–æ–ª—é—Ü–∏–∏"
        ]
        
        for trend in trends:
            conspect_parts.append(f"   ‚Ä¢ {trend}\n")
        
        conspect_parts.append(f"\n4.2 *–°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ò –í–´–í–û–î–´*\n")
        
        recommendations = [
            "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π",
            "–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è",
            "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã —É—Å–ø–µ—Ö–∞",
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
        ]
        
        for rec in recommendations:
            conspect_parts.append(f"   ‚Ä¢ {rec}\n")
        
        conspect_parts.append(f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
        conspect_parts.append(f"üí° –ò–¢–û–ì–û–í–´–ô –ê–ù–ê–õ–ò–ó –ò –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï\n")
        conspect_parts.append(f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n")
        
        # –ò—Ç–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
        conspect_parts.append(f"*–ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:*\n\n")
        
        findings = [
            f"1. –¢–µ–º–∞ '{topic}' –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫—É—é —Å—Ç–µ–ø–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ—Å—Ç–∏",
            "2. –í—ã—è–≤–ª–µ–Ω—ã —É—Å—Ç–æ–π—á–∏–≤—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –¥–∏–Ω–∞–º–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π",
            "4. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –æ–±–ª–∞—Å—Ç—è–º–∏ –∑–Ω–∞–Ω–∏—è",
            "5. –°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ñ–µ—Ä"
        ]
        
        for finding in findings:
            conspect_parts.append(f"   {finding}\n")
        
        conspect_parts.append(f"\n*–ó–ù–ê–ß–ò–ú–û–°–¢–¨ –ò –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–¨:*\n")
        conspect_parts.append(f"–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–º—ã '{topic}' ")
        conspect_parts.append(f"–¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–∞—É–∫–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—ã–µ ")
        conspect_parts.append(f"–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.\n\n")
        
        conspect_parts.append(f"üîÑ *–°–û–ó–î–ê–ù–û –° –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï–ú AI-–¢–ï–•–ù–û–õ–û–ì–ò–ô*\n")
        conspect_parts.append(f"ü§ñ *@Konspekt_help_bot*")
        
        return "".join(conspect_parts)

class SimpleBot:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å Telegram-–±–æ—Ç–∞"""
    
    def __init__(self, token):
        self.token = token
        self.bot_url = f"https://api.telegram.org/bot{token}"
        self.generator = AIConspectGenerator()
        logger.info(f"–ë–æ—Ç @Konspekt_help_bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def start(self, update_id, chat_id):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
        welcome_text = (
            "üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Konspekt Helper Bot!*\n\n"
            
            "–Ø ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è *—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤* –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã.\n\n"
            
            "üéØ *–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*\n"
            "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–≤–æ–π–Ω–∞ –∏ –æ–±—â–µ—Å—Ç–≤–æ')\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–∞\n"
            "3. –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–º—É –∏ —Å–æ–∑–¥–∞–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç\n\n"
            
            "üìä *–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–º—ã:*\n"
            "‚Ä¢ *1* ‚Äî –ö—Ä–∞—Ç–∫–∏–π (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã)\n"
            "‚Ä¢ *2* ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π (—Å –∞–Ω–∞–ª–∏–∑–æ–º –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏)\n"
            "‚Ä¢ *3* ‚Äî –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π (–ø–æ–ª–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)\n\n"
            
            "üîç *–Ø –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ —Å–æ–∑–¥–∞—é –∫–æ–Ω—Å–ø–µ–∫—Ç—ã —Å –ø–æ–º–æ—â—å—é AI-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π*\n\n"
            "üéâ *–í –±–æ—Ç–µ –µ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ –¥–ª—è —Å–∞–º—ã—Ö –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã—Ö!*\n\n"
            "üöÄ *–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ç–µ–º—É!*"
        )
        
        self._update_stats(chat_id)
        return self._send_message(chat_id, welcome_text)
    
    def process_text(self, update_id, chat_id, text):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞—Å—Ö–∞–ª–∫—É
        if self.generator.is_easter_egg(text):
            response = self.generator.generate_easter_egg()
            self._update_stats(chat_id)
            return self._send_message(chat_id, response)
        
        if not text or len(text.strip()) < 2:
            return self._send_message(
                chat_id,
                "üìù *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞*\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ '–í–æ–π–Ω–∞ –∏ –µ—ë –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—â–µ—Å—Ç–≤–æ'\n"
                "‚Ä¢ '–†–∞–∑–≤–∏—Ç–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞'\n"
                "‚Ä¢ '–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏'\n\n"
                "–ß–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ —Ç–µ–º–∞, —Ç–µ–º –ª—É—á—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!"
            )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–º—É
        user_state = stats["user_states"].get(str(chat_id), {})
        user_state["pending_topic"] = text
        stats["user_states"][str(chat_id)] = user_state
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å –æ–±—ä–µ–º
        volume_options = (
            "üéØ *–û—Ç–ª–∏—á–Ω–∞—è —Ç–µ–º–∞! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–∞:*\n\n"
            
            "1Ô∏è‚É£ *–ö–†–ê–¢–ö–ò–ô (0.5-1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞):*\n"
            "‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è\n"
            "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã\n"
            "‚Ä¢ –ö—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã\n\n"
            
            "2Ô∏è‚É£ *–ü–û–î–†–û–ë–ù–´–ô (1-2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã):*\n"
            "‚Ä¢ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–º—ã\n"
            "‚Ä¢ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ —Ä–∞–∑–¥–µ–ª—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏\n"
            "‚Ä¢ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç\n"
            "‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n"
            
            "3Ô∏è‚É£ *–†–ê–ó–í–ï–†–ù–£–¢–´–ô (3-4 —Å—Ç—Ä–∞–Ω–∏—Ü—ã):*\n"
            "‚Ä¢ –ì–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n"
            "‚Ä¢ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è\n"
            "‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã\n\n"
            
            "üî¢ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–∏—Ñ—Ä—É:* 1, 2 –∏–ª–∏ 3"
        )
        
        self._update_stats(chat_id)
        return self._send_message(chat_id, volume_options)
    
    def process_volume_choice(self, update_id, chat_id, choice):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–±—ä–µ–º–∞"""
        user_state = stats["user_states"].get(str(chat_id), {})
        topic = user_state.get("pending_topic", "")
        
        if not topic:
            return self._send_message(
                chat_id,
                "ü§î *–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞*\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É, –∞ –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º."
            )
        
        volume_map = {
            "1": "–∫—Ä–∞—Ç–∫–∏–π",
            "2": "–ø–æ–¥—Ä–æ–±–Ω—ã–π", 
            "3": "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π"
        }
        
        volume = volume_map.get(choice)
        if not volume:
            return self._send_message(
                chat_id,
                "‚ùå *–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä*\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ:\n"
                "1 ‚Äî –ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç\n"
                "2 ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç\n"
                "3 ‚Äî –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç"
            )
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        search_msg = (
            f"üîç *–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–º—É –∏ –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...*\n\n"
            f"üìå *–¢–µ–º–∞:* {topic}\n"
            f"üìä *–û–±—ä–µ–º:* {volume.capitalize()}\n\n"
            f"‚è≥ *–ò—â—É –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏...*"
        )
        self._send_message(chat_id, search_msg)
        
        time.sleep(1)  # –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        
        # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
        search_results = self.generator.simulate_web_search(topic)
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç —Å –ø–æ–º–æ—â—å—é AI
        conspect = self.generator.generate_ai_conspect(topic, volume, search_results)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats["conspects_created"] += 1
        self._update_stats(chat_id)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç
        response = (
            f"‚úÖ *–ö–û–ù–°–ü–ï–ö–¢ –ì–û–¢–û–í!*\n\n"
            f"üìå *–¢–µ–º–∞:* {topic}\n"
            f"üìä *–û–±—ä–µ–º:* {volume.capitalize()}\n"
            f"üîç *–ù–∞–π–¥–µ–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:* {search_results['statistics']}\n\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"{conspect}\n\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"üíæ *–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è*\n\n"
            f"üîÑ *–•–æ—Ç–∏—Ç–µ –¥—Ä—É–≥–æ–π –æ–±—ä–µ–º?* –û—Ç–ø—Ä–∞–≤—å—Ç–µ 1, 2 –∏–ª–∏ 3\n\n"
            f"üéØ *–ù–æ–≤–∞—è —Ç–µ–º–∞?* –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë!"
        )
        
        return self._send_message(chat_id, response)
    
    def _update_stats(self, chat_id):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        user_key = str(chat_id)
        today = datetime.now().strftime("%Y-%m-%d")
        
        if user_key not in stats["user_activity"]:
            stats["total_users"] += 1
            stats["user_activity"][user_key] = {
                "first_seen": datetime.now(),
                "last_seen": datetime.now(),
                "message_count": 0
            }
        
        stats["user_activity"][user_key]["last_seen"] = datetime.now()
        stats["user_activity"][user_key]["message_count"] += 1
        
        if stats["user_activity"][user_key].get("last_active_date") != today:
            stats["active_today"] += 1
            stats["user_activity"][user_key]["last_active_date"] = today
        
        stats["total_messages"] += 1
    
    def _send_message(self, chat_id, text):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram Bot API"""
        import requests
        
        url = f"{self.bot_url}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": text,
            "parse_mode": "Markdown",
            "disable_web_page_preview": True
        }
        
        try:
            response = requests.post(url, json=payload, timeout=10)
            response.raise_for_status()
            logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {chat_id}")
            return response.json()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return None

class BotServer(BaseHTTPRequestHandler):
    """HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –∏ –≤–µ–±-—Å–∞–π—Ç–∞"""
    
    def _set_headers(self, content_type='text/html'):
        self.send_response(200)
        self.send_header('Content-type', content_type)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
    
    def do_GET(self):
        parsed_path = urlparse(self.path)
        path = parsed_path.path
        
        logger.info(f"GET –∑–∞–ø—Ä–æ—Å: {path}")
        
        if path == '/':
            self._serve_main_page()
        elif path == '/health':
            self._serve_health_check()
        elif path == '/stats.json':
            self._serve_stats_json()
        elif path == '/setup-webhook':
            self._setup_webhook_page()
        else:
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
            self.send_error(404, "Page not found".encode('utf-8'))
    
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        
        try:
            update = json.loads(post_data.decode('utf-8'))
            update_id = update.get('update_id', 0)
            logger.info(f"–í–µ–±—Ö—É–∫ #{update_id} –ø–æ–ª—É—á–µ–Ω")
            
            self._process_update(update)
            
            self._set_headers('application/json')
            self.wfile.write(json.dumps({"status": "ok"}).encode('utf-8'))
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞: {e}")
            self.send_response(500)
            self.end_headers()
    
    def _serve_main_page(self):
        webhook_url = os.getenv("RENDER_EXTERNAL_URL", "https://konspekt-helper-bot.onrender.com") + "/webhook"
        start_time = stats["start_time"]
        
        html_content = HTML_TEMPLATE.format(
            webhook_url=webhook_url,
            start_time=start_time
        )
        
        self._set_headers()
        self.wfile.write(html_content.encode('utf-8'))
    
    def _serve_health_check(self):
        health_data = {
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "bot": "@Konspekt_help_bot",
            "version": "6.0.0",
            "features": ["ai-generation", "web-search-simulation", "easter-egg"],
            "stats": stats.copy()
        }
        
        self._set_headers('application/json')
        self.wfile.write(json.dumps(health_data, ensure_ascii=False, indent=2).encode('utf-8'))
    
    def _serve_stats_json(self):
        today = datetime.now().strftime("%Y-%m-%d")
        active_today = sum(
            1 for user_data in stats["user_activity"].values()
            if user_data.get("last_active_date") == today
        )
        stats["active_today"] = active_today
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—Ç–æ –Ω–∞—à–µ–ª –ø–∞—Å—Ö–∞–ª–∫—É
        easter_egg_users = []
        for user_id, state in stats.get("user_states", {}).items():
            topic = state.get("pending_topic", "")
            if topic and AIConspectGenerator.is_easter_egg(topic):
                easter_egg_users.append(user_id)
        
        stats_data = {
            "bot": "@Konspekt_help_bot",
            "timestamp": datetime.now().isoformat(),
            "stats": stats.copy(),
            "easter_egg": {
                "found_by": len(easter_egg_users),
                "users": easter_egg_users[:10]  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10
            }
        }
        
        self._set_headers('application/json')
        self.wfile.write(json.dumps(stats_data, ensure_ascii=False, indent=2).encode('utf-8'))
    
    def _setup_webhook_page(self):
        token = os.getenv("TELEGRAM_TOKEN", "–í–ê–®_–¢–û–ö–ï–ù")
        webhook_url = os.getenv("RENDER_EXTERNAL_URL", "https://konspekt-helper-bot.onrender.com") + "/webhook"
        
        html_content = f"""<!DOCTYPE html>
<html>
<head><title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞</title></head>
<body>
<h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –¥–ª—è @Konspekt_help_bot</h1>
<p><strong>URL –≤–µ–±—Ö—É–∫–∞:</strong> {webhook_url}</p>
<p><strong>–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong></p>
<pre>curl "https://api.telegram.org/bot{token}/setWebhook?url={webhook_url}"</pre>
<p><a href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
</body>
</html>"""
        
        self._set_headers()
        self.wfile.write(html_content.encode('utf-8'))
    
    def _process_update(self, update):
        token = os.getenv("TELEGRAM_TOKEN")
        if not token:
            logger.error("TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            return
        
        bot = SimpleBot(token)
        
        if "message" in update:
            message = update["message"]
            chat_id = message["chat"]["id"]
            text = message.get("text", "").strip()
            update_id = update.get('update_id', 0)
            
            if text.startswith('/'):
                if text.startswith('/start'):
                    bot.start(update_id, chat_id)
                elif text.startswith('/help'):
                    help_text = "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –¥–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞! –ù–∞–ø—Ä–∏–º–µ—Ä: '–≤–æ–π–Ω–∞ –∏ –æ–±—â–µ—Å—Ç–≤–æ'"
                    bot._send_message(chat_id, help_text)
                elif text.startswith('/id'):
                    bot._send_message(chat_id, f"üÜî –í–∞—à ID: `{chat_id}`")
                elif text.startswith('/site'):
                    web_url = os.getenv("RENDER_EXTERNAL_URL", "https://konspekt-helper-bot.onrender.com")
                    bot._send_message(chat_id, f"üåê –°–∞–π—Ç: {web_url}")
                else:
                    bot._send_message(chat_id, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É!")
            elif text in ['1', '2', '3']:
                bot.process_volume_choice(update_id, chat_id, text)
            elif text:
                bot.process_text(update_id, chat_id, text)
    
    def log_message(self, format, *args):
        pass

def start_bot():
    token = os.getenv("TELEGRAM_TOKEN")
    if not token:
        logger.error("TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        logger.info("–î–æ–±–∞–≤—å—Ç–µ TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Render")
        return
    
    bot = SimpleBot(token)
    logger.info("–ë–æ—Ç @Konspekt_help_bot —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≥–æ—Ç–æ–≤")
    logger.info("üéâ –ü–∞—Å—Ö–∞–ª–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (15 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤)")

def start_http_server():
    port = int(os.getenv("PORT", 10000))
    server_address = ('', port)
    
    httpd = HTTPServer(server_address, BotServer)
    logger.info(f"HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    logger.info(f"–í–µ–±-—Å–∞–π—Ç: http://localhost:{port}")
    
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        logger.info("–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {e}")

if __name__ == "__main__":
    logger.info("=" * 60)
    logger.info("–ó–∞–ø—É—Å–∫ @Konspekt_help_bot —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤")
    logger.info("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if "user_states" not in stats:
        stats["user_states"] = {}
    
    token = os.getenv("TELEGRAM_TOKEN")
    if token:
        logger.info("TELEGRAM_TOKEN –Ω–∞–π–¥–µ–Ω")
    else:
        logger.warning("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    
    bot_thread = threading.Thread(target=start_bot, daemon=True)
    bot_thread.start()
    
    start_http_server()
